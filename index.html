<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CONTROL TOTAL V14 - FULL ANALYTICS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; --gasohol: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1300px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; }
        .btn-blue { background: var(--accent); width: 100%; }
        .btn-sim { background: #6366f1; }
        .monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stock-box { padding: 15px; border-radius: 10px; text-align: center; background: #f8fafc; border: 1px solid #e2e8f0; transition: 0.3s; }
        .stock-label { font-size: 2rem; font-weight: 800; display: block; }
        .alerta-critica { background: #fee2e2 !important; border: 2px solid var(--danger) !important; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.8); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 700px; border-radius: 15px; }
        .sim-card { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; display:flex; justify-content:space-between; align-items:center; border:none;">
        <div><h2 style="margin:0">‚õΩ Control Total Pro - Grupo ACP</h2><small id="statusCloud">Sincronizando...</small></div>
        <div style="display:flex; gap:10px;">
            <button onclick="abrirSimulador()" class="btn btn-sim">üìä Simulador / Pedido</button>
            <button onclick="exportarExcel()" class="btn" style="background:#107c41">üì• Excel</button>
        </div>
    </div>

    <div class="card">
        <h3>üìù Registro</h3>
        <select id="tipoMov" onchange="toggleCisterna()"><option value="salida">Salida</option><option value="ingreso">Ingreso</option></select>
        <select id="prod"><option value="DIESEL">Diesel</option><option value="GASOHOL">Gasohol</option></select>
        <input type="number" id="cant" step="0.01" placeholder="Cantidad gl">
        <input type="text" id="referencia" placeholder="Referencia" style="display:none;">
        <button class="btn btn-blue" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
    </div>

    <div class="card">
        <h3>üöö Monitor Stock (Nube)</h3>
        <div class="monitor-grid">
            <div id="boxD" class="stock-box"><b>Diesel</b><span id="sDiesel" class="stock-label" style="color:var(--diesel)">0</span><small id="autD">-- d√≠as</small></div>
            <div id="boxG" class="stock-box"><b>Gasohol</b><span id="sGasohol" class="stock-label" style="color:var(--gasohol)">0</span><small id="autG">-- d√≠as</small></div>
        </div>
    </div>

    <div class="card full-width"><h3>üìà Consumo Semanal (Galones)</h3><canvas id="consumoChart" height="80"></canvas></div>

    <div class="card full-width">
        <h3>üìù Historial Reciente</h3>
        <table>
            <thead><tr><th>Fecha</th><th>Mov</th><th>Producto</th><th>Cant</th><th>Ref</th><th>Saldo</th></tr></thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<div id="modalSimulador" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between;"><h2>üìä Simulador y Orden de Pedido</h2><button onclick="cerrarSimulador()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">‚úï</button></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div class="sim-card"><b>Promedio Diario</b><br>Diesel: <span id="pD">0</span> gl<br>Gasohol: <span id="pG">0</span> gl</div>
            <div class="sim-card" style="background:#e0f2fe;"><b>Autonom√≠a</b><br>Diesel: <span id="dD">0</span> d√≠as<br>Gasohol: <span id="dG">0</span> d√≠as</div>
        </div>
        <div class="sim-card" style="border:2px solid var(--success);">
            <h3>üõí Confirmar Cantidades para Pedido</h3>
            <label>Diesel:</label><input type="number" id="pedD"><label>Gasohol:</label><input type="number" id="pedG">
            <button onclick="enviarPedidoCorreo()" class="btn" style="background:var(--success); width:100%;">üìß Enviar Pedido a Compras (Rafael / Montenegro)</button>
            <p id="envioStatus" style="text-align:center; margin-top:5px;"></p>
        </div>
    </div>
</div>

<script>
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec';
let db = { stockFuel: { diesel: 0, gasohol: 0 }, historial: [] };
let chartObj;

async function cargarDatosDesdeNube() {
    try {
        const res = await fetch(URL_GOOGLE_SHEETS + '?t=' + new Date().getTime());
        const data = await res.json();
        if (data) {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol);
            db.historial = data.historialNube || [];
            actualizarUI(); actualizarGrafico();
        }
    } catch (e) { document.getElementById('statusCloud').innerText = "Modo Local"; }
}

function actualizarUI() {
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);
    document.getElementById('boxD').classList.toggle('alerta-critica', db.stockFuel.diesel < 2500);
    document.getElementById('boxG').classList.toggle('alerta-critica', db.stockFuel.gasohol < 250);
    
    // Autonom√≠a r√°pida
    let totalD = 0, totalG = 0;
    db.historial.filter(h => h.mov === 'SALIDA').slice(0,10).forEach(h => { if(h.prod==='DIESEL') totalD += parseFloat(h.cant); else totalG += parseFloat(h.cant); });
    let pD = (totalD/5); let pG = (totalG/5);
    document.getElementById('autD').innerText = pD > 0 ? (db.stockFuel.diesel/pD).toFixed(1) + " d√≠as" : "--";
    document.getElementById('autG').innerText = pG > 0 ? (db.stockFuel.gasohol/pG).toFixed(1) + " d√≠as" : "--";

    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 10).map(h => `<tr><td>${h.fecha}</td><td>${h.mov}</td><td style="color:${h.prod==='GASOHOL'?'green':'blue'}">${h.prod}</td><td>${h.cant}</td><td>${h.ref}</td><td>${h.saldo}</td></tr>`).join('');
}

function actualizarGrafico() {
    const ctx = document.getElementById('consumoChart').getContext('2d');
    const labels = [...new Set(db.historial.slice(0,30).map(h => h.fecha.split(',')[0]))].reverse().slice(-7);
    const datasetD = labels.map(l => db.historial.filter(h => h.fecha.includes(l) && h.mov==='SALIDA' && h.prod==='DIESEL').reduce((a,b)=>a+parseFloat(b.cant),0));
    const datasetG = labels.map(l => db.historial.filter(h => h.fecha.includes(l) && h.mov==='SALIDA' && h.prod==='GASOHOL').reduce((a,b)=>a+parseFloat(b.cant),0));
    if(chartObj) chartObj.destroy();
    chartObj = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{label:'Diesel', data:datasetD, backgroundColor:'#2563eb'},{label:'Gasohol', data:datasetG, backgroundColor:'#10b981'}]}, options: { responsive: true }});
}

function procesarMovimiento() {
    const mov = document.getElementById('tipoMov').value.toUpperCase();
    const prod = document.getElementById('prod').value;
    const cant = parseFloat(document.getElementById('cant').value);
    const ref = document.getElementById('referencia').value || "S/R";
    if (!cant) return alert("Ingrese cantidad");
    let nD = db.stockFuel.diesel, nG = db.stockFuel.gasohol;
    if(prod==='DIESEL') nD = (mov==='SALIDA'?nD-cant:nD+cant); else nG = (mov==='SALIDA'?nG-cant:nG+cant);
    fetch(URL_GOOGLE_SHEETS, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tipo: mov, producto: prod, cantidad: cant, responsable: ref, stockDiesel: nD, stockGasohol: nG })}).then(() => setTimeout(cargarDatosDesdeNube, 1500));
    document.getElementById('cant').value = "";
}

function abrirSimulador() {
    document.getElementById('modalSimulador').style.display = 'block';
    let tD = db.historial.filter(h=>h.mov==='SALIDA'&&h.prod==='DIESEL').reduce((a,b)=>a+parseFloat(b.cant),0)/7;
    let tG = db.historial.filter(h=>h.mov==='SALIDA'&&h.prod==='GASOHOL').reduce((a,b)=>a+parseFloat(b.cant),0)/7;
    document.getElementById('pD').innerText = tD.toFixed(1); document.getElementById('pG').innerText = tG.toFixed(1);
    document.getElementById('dD').innerText = tD>0?(db.stockFuel.diesel/tD).toFixed(1):0; document.getElementById('dG').innerText = tG>0?(db.stockFuel.gasohol/tG).toFixed(1):0;
    document.getElementById('pedD').value = Math.max(0, (tD*10)-db.stockFuel.diesel).toFixed(0);
    document.getElementById('pedG').value = Math.max(0, (tG*10)-db.stockFuel.gasohol).toFixed(0);
}

function enviarPedidoCorreo() {
    if(!confirm("¬øEnviar pedido formal?")) return;
    const s = document.getElementById('envioStatus'); s.innerText = "Enviando...";
    fetch(URL_GOOGLE_SHEETS, { method:'POST', mode:'no-cors', body: JSON.stringify({ tipo:"PEDIDO_SIMULADO", cantidadDiesel: document.getElementById('pedD').value, cantidadGasohol: document.getElementById('pedG').value, actualD: db.stockFuel.diesel, actualG: db.stockFuel.gasohol })})
    .then(() => { s.innerText = "‚úÖ Enviado"; setTimeout(cerrarSimulador, 2000); });
}

function cerrarSimulador() { document.getElementById('modalSimulador').style.display = 'none'; }
function toggleCisterna() { document.getElementById('referencia').style.display = (document.getElementById('tipoMov').value === 'ingreso') ? 'block' : 'none'; }
function exportarExcel() { /* L√≥gica est√°ndar XLSX */ }
cargarDatosDesdeNube(); setInterval(cargarDatosDesdeNube, 60000);
</script>
</body>
</html>
