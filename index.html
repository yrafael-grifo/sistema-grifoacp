<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CONTROL TOTAL V14 - FULL HISTORIAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; 
            --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #059669;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #334155; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1350px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; text-align: center; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-excel { background: #107c41; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .status-badge { padding: 5px 10px; border-radius: 6px; font-size: 0.85em; font-weight: bold; }
        .bg-danger { background: #fee2e2; color: var(--danger); border: 1px solid var(--danger); }
        .bg-success { background: #dcfce7; color: var(--gasohol); }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .stock-label { font-size: 1.8rem; font-weight: bold; display: block; margin: 5px 0; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; border:none; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">‚õΩ Control de Suministro Pro (Reserva 24h)</h1>
            <small id="statusCloud" style="color: #94a3b8;">‚åõ Sincronizando con Excel...</small>
        </div>
        <button onclick="exportarExcel()" class="btn btn-excel">üì• Descargar Reporte EXCEL (.xlsx)</button>
    </div>

    <div class="card">
        <h2>üìë Registro de Operaci√≥n</h2>
        <label>Tipo de Movimiento</label>
        <select id="tipoMov" onchange="toggleCisterna()">
            <option value="salida">Salida (Consumo Diario)</option>
            <option value="ingreso">Ingreso (Cisterna / Compra)</option>
        </select>
        <label>Producto</label>
        <select id="prod">
            <option value="diesel">Diesel (Cap: 5000 gl)</option>
            <option value="gasohol">Gasohol (Cap: 1000 gl)</option>
        </select>
        <label>Cantidad (Galones)</label>
        <input type="number" id="cant" step="0.01" placeholder="0.00">
        
        <div id="extraData" style="display:none;">
            <label>Referencia (Placa/Chofer/Factura)</label>
            <input type="text" id="referencia" placeholder="Ej: Cisterna ABC-123">
        </div>
        
        <button class="btn btn-blue" style="width:100%" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
    </div>

    <div class="card">
        <h2>üöö Monitor de Pedidos (Reserva 24h)</h2>
        <div id="alertasContainer"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top:10px;">
            <div class="status-badge bg-success" style="text-align:center; padding:15px; border:1px solid #10b981">
                <b>Diesel Actual</b>
                <span id="sDiesel" class="stock-label">0</span>
            </div>
            <div class="status-badge bg-success" style="text-align:center; padding:15px; border:1px solid #10b981">
                <b>Gasohol Actual</b>
                <span id="sGasohol" class="stock-label">0</span>
            </div>
        </div>
    </div>

    <div class="card full-width">
        <h2>üìù Historial de Ingresos y Salidas</h2>
        <table>
            <thead>
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Operaci√≥n</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Referencia</th>
                    <th>Saldo Final</th>
                </tr>
            </thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<script>
// --- CONFIGURACI√ìN ---
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec'; 

let db = JSON.parse(localStorage.getItem('fuel_v14_final')) || {
    stockFuel: { diesel: 5000, gasohol: 1000 },
    historial: []
};

function toggleCisterna() {
    document.getElementById('extraData').style.display = (document.getElementById('tipoMov').value === 'ingreso') ? 'block' : 'none';
}

// 1. CARGAR DATOS (Recibe Diesel y Gasohol)
async function cargarDatosDesdeNube() {
    const status = document.getElementById('statusCloud');
    try {
        const response = await fetch(URL_GOOGLE_SHEETS);
        const data = await response.json();
        if (data) {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel || 5000);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol || 1000);
            status.innerText = "‚úÖ Sincronizado con Excel";
            status.style.color = "#10b981";
            actualizarUI();
        }
    } catch (e) {
        status.innerText = "‚ö†Ô∏è Modo Local Activo";
    }
}

// 2. ENVIAR DATOS (Env√≠a ambos stocks para mantener consistencia)
function enviarANube(mov, prod, cant, ref) {
    fetch(URL_GOOGLE_SHEETS, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            tipo: mov,
            cantidad: cant + " (" + prod + ")",
            responsable: ref,
            stockDiesel: db.stockFuel.diesel,
            stockGasohol: db.stockFuel.gasohol
        })
    });
}

function procesarMovimiento() {
    const mov = document.getElementById('tipoMov').value;
    const prod = document.getElementById('prod').value;
    const cant = parseFloat(document.getElementById('cant').value);
    const ref = document.getElementById('referencia').value || (mov === 'salida' ? 'DESPACHO' : 'INGRESO');

    if (isNaN(cant) || cant <= 0) return alert("Cantidad inv√°lida");

    if (mov === 'salida') {
        if (db.stockFuel[prod] < cant) return alert("Stock insuficiente");
        db.stockFuel[prod] = Number((db.stockFuel[prod] - cant).toFixed(2));
    } else {
        db.stockFuel[prod] = Number((db.stockFuel[prod] + cant).toFixed(2));
    }

    const nuevaOp = {
        fecha: new Date().toLocaleString(),
        mov: mov.toUpperCase(),
        prod: prod.toUpperCase(),
        cant: cant.toFixed(2),
        ref: ref.toUpperCase(),
        saldo: db.stockFuel[prod]
    };

    db.historial.unshift(nuevaOp);
    enviarANube(mov.toUpperCase(), prod.toUpperCase(), cant.toFixed(2), ref.toUpperCase());
    actualizarUI();
    document.getElementById('cant').value = "";
}

function actualizarUI() {
    localStorage.setItem('fuel_v14_final', JSON.stringify(db));
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);

    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 15).map(h => `
        <tr>
            <td>${h.fecha}</td>
            <td style="color:${h.mov==='INGRESO'?'green':'red'}"><b>${h.mov}</b></td>
            <td style="color:${h.prod==='GASOHOL'?'var(--gasohol)':'var(--diesel)'}"><b>${h.prod}</b></td>
            <td>${h.cant}</td>
            <td>${h.ref}</td>
            <td><b>${h.saldo}</b></td>
        </tr>`).join('');
}

function exportarExcel() {
    const historialMayusculas = db.historial.map(h => ({
        "FECHA Y HORA": h.fecha,
        "OPERACI√ìN": h.mov,
        "PRODUCTO": h.prod,
        "CANTIDAD": h.cant,
        "REFERENCIA": h.ref,
        "SALDO FINAL": h.saldo
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(historialMayusculas);
    XLSX.utils.book_append_sheet(wb, ws, "HISTORIAL");
    XLSX.writeFile(wb, "REPORTE_COMBUSTIBLE_MAYUSCULAS.xlsx");
}

actualizarUI();
cargarDatosDesdeNube();
</script>
</body>
</html>
