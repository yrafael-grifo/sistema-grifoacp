<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CONTROL TOTAL V14 - SIMULADOR PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; 
            --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #059669;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #334155; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1350px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; text-align: center; }
        .btn-blue { background: var(--accent); }
        .btn-sim { background: var(--primary); border: 1px solid #475569; }
        .btn-excel { background: #107c41; }
        .btn-green { background: var(--success); }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .stock-label { font-size: 1.8rem; font-weight: bold; display: block; margin: 5px 0; }
        
        /* ESTILOS DEL SIMULADOR (MODAL) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; width: 80%; max-width: 800px; border-radius: 15px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
        .sim-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .sim-resumen { background: #f8fafc; padding: 15px; border-radius: 10px; border-left: 5px solid var(--accent); }
        .text-diesel { color: var(--diesel); font-weight: bold; }
        .text-gasohol { color: var(--gasohol); font-weight: bold; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; border:none; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">‚õΩ Control de Suministro Pro</h1>
            <small id="statusCloud" style="color: #94a3b8;">‚åõ Sincronizando Diesel y Gasohol...</small>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="abrirSimulador()" class="btn btn-sim">üìä Simular Compra</button>
            <button onclick="exportarExcel()" class="btn btn-excel">üì• Reporte EXCEL</button>
        </div>
    </div>

    <div class="card">
        <h2>üìë Registro de Operaci√≥n</h2>
        <label>Tipo de Movimiento</label>
        <select id="tipoMov" onchange="toggleCisterna()">
            <option value="salida">Salida (Consumo Diario)</option>
            <option value="ingreso">Ingreso (Cisterna / Compra)</option>
        </select>
        <label>Producto</label>
        <select id="prod">
            <option value="DIESEL">Diesel</option>
            <option value="GASOHOL">Gasohol</option>
        </select>
        <label>Cantidad (Galones)</label>
        <input type="number" id="cant" step="0.01" placeholder="0.00">
        <div id="extraData" style="display:none;">
            <label>Referencia (Placa/Factura)</label>
            <input type="text" id="referencia" placeholder="Ej: Cisterna ABC-123">
        </div>
        <button class="btn btn-blue" style="width:100%" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
    </div>

    <div class="card">
        <h2>üöö Monitor de Pedidos (Nube)</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="card" style="text-align:center; padding:10px; border:1px solid #e2e8f0">
                <b>Diesel Actual</b>
                <span id="sDiesel" class="stock-label text-diesel">0</span>
            </div>
            <div class="card" style="text-align:center; padding:10px; border:1px solid #e2e8f0">
                <b>Gasohol Actual</b>
                <span id="sGasohol" class="stock-label text-gasohol">0</span>
            </div>
        </div>
    </div>

    <div class="card full-width">
        <h2>üõ† Plan de Mantenimiento y Filtros</h2>
        <table>
            <thead>
                <tr><th>Unidad</th><th>Filtro</th><th>√öltima Fecha</th><th>D√≠as</th><th>Estado</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody id="mantoBody"></tbody>
        </table>
    </div>

    <div class="card full-width">
        <h2>üìù Historial Reciente</h2>
        <table>
            <thead>
                <tr><th>Fecha</th><th>Operaci√≥n</th><th>Producto</th><th>Cantidad</th><th>Referencia</th><th>Saldo</th></tr>
            </thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<div id="modalSimulador" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">üìä Simulador de Compra de Combustible</h2>
            <button onclick="cerrarSimulador()" style="background:none; border:none; font-size:2rem; cursor:pointer;">&times;</button>
        </div>
        <hr>
        <div class="sim-grid">
            <div class="sim-resumen">
                <h3>üìà Consumo Promedio (7 d√≠as)</h3>
                <p>Diesel: <span id="promDiesel">0</span> gl/d√≠a</p>
                <p>Gasohol: <span id="promGasohol">0</span> gl/d√≠a</p>
            </div>
            <div class="sim-resumen" style="border-left-color: var(--success);">
                <h3>‚õΩ Sugerencia de Pedido</h3>
                <p>Pedir Diesel: <b><span id="pedirDiesel">0</span> gl</b></p>
                <p>Pedir Gasohol: <b><span id="pedirGasohol">0</span> gl</b></p>
                <small>*Para cubrir los pr√≥ximos 7 d√≠as con reserva.</small>
            </div>
        </div>
        <div style="margin-top:20px;">
            <h3>üõ† Proyecci√≥n de Llenado</h3>
            <label>Cantidad a comprar Diesel:</label>
            <input type="number" id="simDiesel" oninput="simular()" placeholder="0.00">
            <label>Cantidad a comprar Gasohol:</label>
            <input type="number" id="simGasohol" oninput="simular()" placeholder="0.00">
            <div id="resultadoSim" style="padding:15px; margin-top:10px; border-radius:8px; font-weight:bold;"></div>
        </div>
    </div>
</div>

<script>
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec'; 

let db = {
    stockFuel: { diesel: 5000, gasohol: 1000 },
    stockFiltros: { cf60: 3, cf100: 2 }, 
    historial: [],
    equipos: [
        { id: 'Surtidor 1 Diesel', f: 'CF60', ult: '2026-01-15' },
        { id: 'Surtidor 2 Diesel', f: 'CF60', ult: '2026-01-23' },
        { id: 'Hipotanque (M√≥vil)', f: 'CF100', ult: '2025-12-10' },
        { id: 'Surtidor Gasohol', f: 'MALLA', ult: '2026-01-15' }
    ]
};

// --- FUNCIONES DEL SIMULADOR ---
function abrirSimulador() {
    document.getElementById('modalSimulador').style.display = 'block';
    calcularConsumos();
}
function cerrarSimulador() { document.getElementById('modalSimulador').style.display = 'none'; }

function calcularConsumos() {
    let totalD = 0, totalG = 0;
    let hoy = new Date();
    // Filtramos solo salidas de los √∫ltimos 7 d√≠as
    let sieteDiasAtras = new Date().setDate(hoy.getDate() - 7);
    
    db.historial.forEach(h => {
        let fechaH = new Date(h.fecha);
        if(h.mov === 'SALIDA' && fechaH > sieteDiasAtras) {
            if(h.prod === 'DIESEL') totalD += parseFloat(h.cant);
            else totalG += parseFloat(h.cant);
        }
    });

    let pD = (totalD / 7).toFixed(2);
    let pG = (totalG / 7).toFixed(2);
    
    document.getElementById('promDiesel').innerText = pD;
    document.getElementById('promGasohol').innerText = pG;

    // Sugerencia: (Consumo diario * 7) - Stock Actual + Reserva Seguridad (15%)
    let sugD = Math.max(0, (pD * 7 * 1.15) - db.stockFuel.diesel).toFixed(0);
    let sugG = Math.max(0, (pG * 7 * 1.15) - db.stockFuel.gasohol).toFixed(0);

    document.getElementById('pedirDiesel').innerText = sugD;
    document.getElementById('pedirGasohol').innerText = sugG;
}

function simular() {
    let inD = parseFloat(document.getElementById('simDiesel').value) || 0;
    let inG = parseFloat(document.getElementById('simGasohol').value) || 0;
    let res = document.getElementById('resultadoSim');
    
    let nuevoD = db.stockFuel.diesel + inD;
    let nuevoG = db.stockFuel.gasohol + inG;

    if(nuevoD > 5000 || nuevoG > 1000) {
        res.style.background = "#fee2e2"; res.style.color = "#ef4444";
        res.innerText = "‚ö†Ô∏è ADVERTENCIA: ¬°El pedido excede la capacidad del tanque!";
    } else {
        res.style.background = "#dcfce7"; res.style.color = "#15803d";
        res.innerText = `‚úÖ Stock proyectado tras compra: Diesel ${nuevoD.toFixed(2)} gl | Gasohol ${nuevoG.toFixed(2)} gl`;
    }
}

// --- FUNCIONES CORE (Sincronizaci√≥n y Registro) ---
async function cargarDatosDesdeNube() {
    try {
        const response = await fetch(URL_GOOGLE_SHEETS + '?t=' + new Date().getTime());
        const data = await response.json();
        if (data) {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol);
            db.historial = data.historialNube || [];
            actualizarUI();
        }
    } catch (e) { console.log("Modo local activo"); }
}

function procesarMovimiento() {
    const mov = document.getElementById('tipoMov').value;
    const prod = document.getElementById('prod').value;
    const cant = parseFloat(document.getElementById('cant').value);
    const ref = document.getElementById('referencia').value || (mov === 'salida' ? 'DESPACHO' : 'INGRESO');

    if (isNaN(cant) || cant <= 0) return alert("Cantidad inv√°lida");

    const pKey = prod.toLowerCase();
    if (mov === 'salida') {
        if (db.stockFuel[pKey] < cant) return alert("Stock insuficiente");
        db.stockFuel[pKey] -= cant;
    } else {
        db.stockFuel[pKey] += cant;
    }

    enviarANube(mov.toUpperCase(), prod.toUpperCase(), cant.toFixed(2), ref.toUpperCase());
    actualizarUI();
    document.getElementById('cant').value = "";
}

function enviarANube(mov, prod, cant, ref) {
    fetch(URL_GOOGLE_SHEETS, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            tipo: mov, producto: prod, cantidad: cant, responsable: ref,
            stockDiesel: db.stockFuel.diesel, stockGasohol: db.stockFuel.gasohol
        })
    }).then(() => setTimeout(cargarDatosDesdeNube, 2000));
}

function actualizarUI() {
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);
    
    const hoy = new Date();
    document.getElementById('mantoBody').innerHTML = db.equipos.map((e, i) => {
        const diff = Math.floor((hoy - new Date(e.ult)) / (1000*60*60*24));
        let c = diff >= 90 ? "bg-danger" : (diff >= 80 ? "bg-warning" : "bg-success");
        return `<tr><td><b>${e.id}</b></td><td><code>${e.f}</code></td><td>${e.ult}</td><td>${diff}d</td>
        <td><span class="status-badge ${c}">${diff>=90?'VENCIDO':'OK'}</span></td>
        <td><button class="btn btn-blue" onclick="hacerManto(${i})">Reset</button></td></tr>`;
    }).join('');

    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 15).map(h => `
        <tr><td>${h.fecha}</td><td style="color:${h.mov==='INGRESO'?'green':'red'}"><b>${h.mov}</b></td>
        <td style="color:${h.prod==='GASOHOL'?'var(--gasohol)':'var(--diesel)'}"><b>${h.prod}</b></td>
        <td>${h.cant}</td><td>${h.ref}</td><td><b>${h.saldo}</b></td></tr>`).join('');
}

function toggleCisterna() { document.getElementById('extraData').style.display = (document.getElementById('tipoMov').value === 'ingreso') ? 'block' : 'none'; }
function reponerFiltro(t) { db.stockFiltros[t]++; actualizarUI(); }
function exportarExcel() { /* L√≥gica XLSX de siempre */ }

cargarDatosDesdeNube();
setInterval(cargarDatosDesdeNube, 30000);
</script>
</body>
</html>
