<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CONTROL ACP V15</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --bg: #f1f5f9; --card: #ffffff; --primary: #0f172a; --accent: #3b82f6; 
            --diesel: #2563eb; --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #22c55e; 
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 1400px; margin: auto; display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
        
        .header { grid-column: span 12; display: flex; justify-content: space-between; align-items: center; background: var(--primary); padding: 15px 30px; border-radius: 12px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        .card { background: var(--card); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-title { font-weight: 700; margin-bottom: 15px; color: var(--primary); font-size: 1.1rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; }

        .stock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stock-item { padding: 15px; border-radius: 10px; border: 2px solid #f1f5f9; text-align: center; }
        .val { font-size: 2.2rem; font-weight: 800; display: block; margin: 5px 0; }
        .auton { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; background: #f1f5f9; }

        .sem-ok { border-color: var(--success); background: #f0fdf4; }
        .sem-alert { border-color: var(--warning); background: #fffbeb; }
        .sem-crit { border-color: var(--danger); background: #fef2f2; }

        .btn { cursor: pointer; padding: 10px 15px; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; text-align: center; }
        .btn-main { background: var(--accent); color: white; width: 100%; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        
        input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 12px; box-sizing: border-box; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        th { text-align: left; padding: 10px; font-size: 0.75rem; text-transform: uppercase; color: #64748b; border-bottom: 2px solid #f1f5f9; }
        td { padding: 10px; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-c { background: white; margin: 5% auto; padding: 25px; width: 500px; border-radius: 15px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div><h2 style="margin:0">‚õΩ Control Operativo ACP</h2><small id="cStatus">Conectando...</small></div>
        <div style="display:flex; gap:10px;">
            <button onclick="f_openSim()" class="btn btn-sec">üìä Simulador</button>
            <button onclick="f_excel()" class="btn btn-sec" style="background:var(--success)">üì• Excel</button>
        </div>
    </div>

    <div class="card" style="grid-column: span 4;">
        <div class="card-title">üìù Registro</div>
        <label>Operaci√≥n</label>
        <select id="iMov" onchange="f_check()"><option value="SALIDA">Despacho (Salida)</option><option value="INGRESO">Cisterna (Ingreso)</option></select>
        <label>Producto</label>
        <select id="iProd"><option value="DIESEL">Diesel</option><option value="GASOHOL">Gasohol</option></select>
        <label>Cantidad (Gln)</label>
        <input type="number" id="iCant" placeholder="0.00">
        <div id="iExtra" style="display:none;"><label>Referencia</label><input type="text" id="iRef" placeholder="Placa / Doc"></div>
        <button id="btnSave" class="btn btn-main" onclick="f_save()">Registrar Movimiento</button>
    </div>

    <div class="card" style="grid-column: span 8;">
        <div class="card-title">üöö Monitor de Stock Real</div>
        <div class="stock-grid">
            <div id="mD" class="stock-item">
                <b>DIESEL B5 S50</b>
                <span id="vD" class="val" style="color:var(--diesel)">0.00</span>
                <div id="aD" class="auton">---</div>
            </div>
            <div id="mG" class="stock-item">
                <b>GASOHOL REGULAR</b>
                <span id="vG" class="val" style="color:var(--gasohol)">0.00</span>
                <div id="aG" class="auton">---</div>
            </div>
        </div>
    </div>

    <div class="card" style="grid-column: span 12;">
        <div class="card-title">üõ† Mantenimiento de Equipos</div>
        <table>
            <thead><tr><th>Equipo</th><th>Filtro</th><th>Ult. Cambio</th><th>D√≠as</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
            <tbody id="mT"></tbody>
        </table>
    </div>

    <div class="card" style="grid-column: span 12;">
        <div class="card-title">üìù Historial de Movimientos</div>
        <table>
            <thead><tr><th>Fecha</th><th>Tipo</th><th>Producto</th><th>Cant.</th><th>Saldo</th></tr></thead>
            <tbody id="hT"></tbody>
        </table>
    </div>
</div>

<div id="modSim" class="modal">
    <div class="modal-c">
        <h3>üìä Planificaci√≥n de Reposici√≥n</h3>
        <div style="background:#f8fafc; padding:15px; border-radius:10px; margin-bottom:15px; border-left:5px solid var(--accent);">
            <b>Sugerencia de Pedido:</b><br>
            <span id="txtSug">Analizando stock...</span>
        </div>
        <label>Diesel a pedir:</label><input type="number" id="pD">
        <label>Gasohol a pedir:</label><input type="number" id="pG">
        <button onclick="f_send()" class="btn btn-main" style="background:var(--primary)">üìß Enviar Pedido a Log√≠stica</button>
        <button onclick="f_closeSim()" class="btn" style="width:100%; margin-top:10px; background:#e2e8f0;">Cerrar</button>
    </div>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec';
let db = { s: { d: 0, g: 0 }, h: [], m: [{e:'Surtidor 1', f:'CF60', u:'2026-01-15'},{e:'Surtidor 2', f:'CF60', u:'2026-01-23'},{e:'Hipotanque', f:'CF100', u:'2025-12-10'},{id:'Gasohol', f:'MALLA', u:'2026-01-15'}] };

async function f_load() {
    try {
        const r = await fetch(SCRIPT_URL + '?t=' + new Date().getTime());
        const d = await r.json();
        db.s.d = parseFloat(d.ultimoDiesel);
        db.s.g = parseFloat(d.ultimoGasohol);
        db.h = d.historialNube || [];
        f_render();
        document.getElementById('cStatus').innerText = "‚úÖ Sincronizado";
    } catch (e) { document.getElementById('cStatus').innerText = "‚ùå Error de Red"; }
}

function f_render() {
    const aD = (db.s.d / 1700).toFixed(1);
    const aG = (db.s.g / 165).toFixed(1);
    document.getElementById('vD').innerText = db.s.d.toLocaleString();
    document.getElementById('vG').innerText = db.s.g.toLocaleString();
    document.getElementById('aD').innerText = aD + " d√≠as";
    document.getElementById('aG').innerText = aG + " d√≠as";

    const mD = document.getElementById('mD'); mD.className = 'stock-item';
    if(aD < 1) mD.classList.add('sem-crit'); else if(aD < 2) mD.classList.add('sem-alert'); else mD.classList.add('sem-ok');

    const mG = document.getElementById('mG'); mG.className = 'stock-item';
    if(aG < 2) mG.classList.add('sem-crit'); else if(aG < 4) mG.classList.add('sem-alert'); else mG.classList.add('sem-ok');

    const hoy = new Date();
    document.getElementById('mT').innerHTML = db.m.map((x, i) => {
        const diff = Math.floor((hoy - new Date(x.u)) / 86400000);
        return `<tr><td><b>${x.e}</b></td><td>${x.f}</td><td>${x.u}</td><td>${diff} d</td><td>${diff>=90?'AVISO':'OK'}</td><td><button onclick="f_resetM(${i})">Reset</button></td></tr>`;
    }).join('');
    document.getElementById('hT').innerHTML = db.h.slice(0,10).map(x => `<tr><td>${x.fecha}</td><td>${x.mov}</td><td>${x.prod}</td><td>${x.cant}</td><td><b>${x.saldo}</b></td></tr>`).join('');
}

function f_save() {
    const b = document.getElementById('btnSave');
    const m = document.getElementById('iMov').value;
    const p = document.getElementById('iProd').value;
    const c = parseFloat(document.getElementById('iCant').value);
    const r = document.getElementById('iRef').value || "DESPACHO";
    if(!c) return alert("Cantidad vac√≠a");

    let nD = db.s.d; let nG = db.s.g;
    if(p === 'DIESEL') nD = m === 'SALIDA' ? nD - c : nD + c; else nG = m === 'SALIDA' ? nG - c : nG + c;

    b.disabled = true; b.innerText = "Guardando...";
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tipo: m, producto: p, cantidad: c, responsable: r, stockDiesel: nD.toFixed(2), stockGasohol: nG.toFixed(2) }) })
    .then(() => { db.s.d = nD; db.s.g = nG; f_render(); setTimeout(() => { f_load(); b.disabled = false; b.innerText = "Registrar Movimiento"; document.getElementById('iCant').value=""; }, 1500); });
}

function f_openSim() {
    document.getElementById('modSim').style.display = 'block';
    const sD = db.s.d; const sG = db.s.g;
    let sugD = sD < 3400 ? 3000 : 0;
    let sugG = sG < 400 ? 500 : 0;
    document.getElementById('txtSug').innerText = (sugD > 0 || sugG > 0) ? "‚ö†Ô∏è Stock bajo detectado. Se sugiere pedir " + sugD + " gl de Diesel." : "‚úÖ Niveles estables.";
    document.getElementById('pD').value = sugD; document.getElementById('pG').value = sugG;
}

function f_send() {
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tipo: "PEDIDO_SIMULADO", cantidadDiesel: document.getElementById('pD').value, cantidadGasohol: document.getElementById('pG').value, actualD: db.s.d, actualG: db.s.g }) })
    .then(() => { alert("Pedido enviado"); f_closeSim(); });
}

function f_excel() {
    const ws = XLSX.utils.json_to_sheet(db.h);
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "Reporte_Combustible.xlsx");
}

function f_closeSim() { document.getElementById('modSim').style.display = 'none'; }
function f_check() { document.getElementById('iExtra').style.display = document.getElementById('iMov').value === 'INGRESO' ? 'block' : 'none'; }
function f_resetM(i) { db.m[i].u = new Date().toISOString().split('T')[0]; f_render(); }

f_load();
setInterval(f_load, 30000);
</script>
</body>
</html>
