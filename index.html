<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA ACP V15 PRO - COMPLETO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --bg:#f1f5f9; --c:#ffffff; --p:#0f172a; --a:#3b82f6; --d:#2563eb; --g:#10b981; --err:#ef4444; --warn:#f59e0b; --ok:#22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; }
        .container { max-width: 1400px; margin: auto; display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
        .header { grid-column: span 12; display: flex; justify-content: space-between; align-items: center; background: var(--p); padding: 15px 30px; border-radius: 12px; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .card { background: var(--c); border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card-title { font-weight: 700; margin-bottom: 15px; color: var(--p); border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; display: flex; justify-content: space-between; }
        .stock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stock-item { padding: 15px; border-radius: 10px; border: 2px solid #f1f5f9; text-align: center; }
        .val { font-size: 2.2rem; font-weight: 800; display: block; margin: 5px 0; }
        .auton { display: inline-block; padding: 3px 10px; border-radius: 6px; font-size: 0.8rem; font-weight: 600; background: #f1f5f9; }
        .sem-ok { border-color: var(--ok); background: #f0fdf4; }
        .sem-alert { border-color: var(--warn); background: #fffbeb; }
        .sem-crit { border-color: var(--err); background: #fef2f2; }
        .btn { cursor: pointer; padding: 10px 15px; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; text-align: center; }
        .btn-main { background: var(--a); color: white; width: 100%; margin-top: 5px; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
        input, select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 12px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; font-size: 0.75rem; color: #64748b; border-bottom: 2px solid #f1f5f9; background: #f8fafc; }
        td { padding: 10px; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }
        .filter-bar { display: flex; gap: 15px; background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px; align-items: flex-end; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(3px); }
        .modal-c { background: white; margin: 5% auto; padding: 25px; width: 500px; border-radius: 15px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div><h2 style="margin:0">‚õΩ Control ACP - V15 PRO</h2><small id="netStatus">‚è≥ Conectando con Google Sheets...</small></div>
        <div style="display:flex; gap:10px;">
            <button onclick="opSim()" class="btn btn-sec">üìä Simulador</button>
            <button onclick="doExcel()" class="btn btn-sec" style="background:var(--ok)">üì• Excel Filtrado</button>
        </div>
    </div>

    <div class="card" style="grid-column: span 4;">
        <div class="card-title">üìù Registro de Movimiento</div>
        <label>Fecha del Evento:</label>
        <input type="datetime-local" id="inFecha">
        <label>Operaci√≥n:</label>
        <select id="inMov" onchange="chIng()"><option value="SALIDA">Despacho (Salida)</option><option value="INGRESO">Cisterna (Ingreso)</option><option value="AJUSTE">Lectura Varillaje (Ajuste)</option></select>
        <label>Producto:</label>
        <select id="inProd"><option value="DIESEL">Diesel B5 S50</option><option value="GASOHOL">Gasohol Regular</option></select>
        <label id="lblCant">Cantidad (Gln):</label>
        <input type="number" id="inCant" placeholder="0.00">
        <div id="inExtra" style="display:none;"><label>Referencia:</label><input type="text" id="inRef" placeholder="Placa / Factura"></div>
        <button id="btnSave" class="btn btn-main" onclick="doSave()">Guardar Registro</button>
    </div>

    <div class="card" style="grid-column: span 8;">
        <div class="card-title">üöö Monitor Stock (Consumo 24h: 1,700/165 gl)</div>
        <div class="stock-grid">
            <div id="mD" class="stock-item"><b>DIESEL B5 S50</b><span id="vD" class="val" style="color:var(--d)">0.00</span><div id="aD" class="auton">---</div></div>
            <div id="mG" class="stock-item"><b>GASOHOL REGULAR</b><span id="vG" class="val" style="color:var(--g)">0.00</span><div id="aG" class="auton">---</div></div>
        </div>
    </div>

    <div class="card" style="grid-column: span 12;">
        <div class="card-title">üõ† Plan de Mantenimiento de Filtros</div>
        <table>
            <thead><tr><th>Equipo</th><th>Filtro</th><th>√öltimo Cambio</th><th>D√≠as</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
            <tbody id="mBody"></tbody>
        </table>
    </div>

    <div class="card" style="grid-column: span 12;">
        <div class="card-title">üìù Historial y Auditor√≠a <span id="counter" style="font-size:0.8rem; background:#f1f5f9; padding:2px 8px; border-radius:5px;">Cargando...</span></div>
        <div class="filter-bar">
            <div style="flex:1"><label>Desde:</label><input type="date" id="fDesde" onchange="filterData()"></div>
            <div style="flex:1"><label>Hasta:</label><input type="date" id="fHasta" onchange="filterData()"></div>
            <button onclick="clearFilter()" class="btn" style="background:#64748b; color:white; height:42px;">Limpiar Filtros</button>
        </div>
        <table>
            <thead><tr><th>Fecha / Hora</th><th>Operaci√≥n</th><th>Producto</th><th>Cant.</th><th>Referencia</th><th>Saldo Final</th></tr></thead>
            <tbody id="hBody"></tbody>
        </table>
    </div>
</div>

<div id="modSim" class="modal">
    <div class="modal-c">
        <h3>üìä An√°lisis Sugerido</h3>
        <p id="txtSug" style="font-weight:600; border-left:5px solid var(--a); padding-left:10px;"></p>
        <label>Diesel a pedir:</label><input type="number" id="pD">
        <label>Gasohol a pedir:</label><input type="number" id="pG">
        <button onclick="doSend()" class="btn btn-main" style="background:var(--p)">üìß Enviar Pedido a Log√≠stica</button>
        <button onclick="clSim()" class="btn" style="width:100%; margin-top:10px; background:#e2e8f0;">Cerrar</button>
    </div>
</div>

<script>
const URL_BASE = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec'; // <--- PEGA TU URL DE GOOGLE SHEETS AQUI

let core = { 
    s: { d: 0, g: 0 }, 
    h: [], 
    f: [],
    m: [
        {e:'Surtidor 1 Diesel', f:'CF60', u:'2026-01-15'},
        {e:'Surtidor 2 Diesel', f:'CF60', u:'2026-01-23'},
        {e:'Hipotanque M√≥vil', f:'CF100', u:'2025-12-10'},
        {e:'Surtidor Gasohol', f:'MALLA', u:'2026-01-15'}
    ] 
};

function setNow() {
    const n = new Date(); n.setMinutes(n.getMinutes() - n.getTimezoneOffset());
    document.getElementById('inFecha').value = n.toISOString().slice(0, 16);
}

async function fLoad() {
    try {
        const r = await fetch(URL_BASE + '?t=' + new Date().getTime());
        const d = await r.json();
        core.s.d = parseFloat(d.ultimoDiesel) || 0;
        core.s.g = parseFloat(d.ultimoGasohol) || 0;
        core.h = d.historialNube || [];
        core.f = [...core.h];
        renderStock();
        renderManto();
        filterData();
        document.getElementById('netStatus').innerText = "‚úÖ Sincronizado";
    } catch (e) { 
        document.getElementById('netStatus').innerText = "‚ö†Ô∏è Error de red. Reconectando...";
        setTimeout(fLoad, 3000);
    }
}

function renderStock() {
    const aD = (core.s.d / 1700).toFixed(1);
    const aG = (core.s.g / 165).toFixed(1);
    document.getElementById('vD').innerText = core.s.d.toLocaleString(undefined,{minimumFractionDigits:2});
    document.getElementById('vG').innerText = core.s.g.toLocaleString(undefined,{minimumFractionDigits:2});
    document.getElementById('aD').innerText = aD + " d√≠as";
    document.getElementById('aG').innerText = aG + " d√≠as";
    
    const bD = document.getElementById('mD'); bD.className = 'stock-item ' + (aD<1?'sem-crit':aD<2?'sem-alert':'sem-ok');
    const bG = document.getElementById('mG'); bG.className = 'stock-item ' + (aG<1.5?'sem-crit':aG<3?'sem-alert':'sem-ok');
}

function renderManto() {
    const hoy = new Date();
    document.getElementById('mBody').innerHTML = core.m.map((x, i) => {
        const diff = Math.floor((hoy - new Date(x.u)) / 86400000);
        let color = diff >= 90 ? 'var(--err)' : (diff >= 80 ? 'var(--warn)' : 'var(--ok)');
        return `<tr><td><b>${x.e}</b></td><td><code>${x.f}</code></td><td>${x.u}</td><td>${diff} d</td>
        <td><span class="badge" style="background:${color}22; color:${color}">${diff>=90?'VENCIDO':'OK'}</span></td>
        <td><button onclick="reM(${i})" class="btn" style="padding:4px 8px; font-size:0.7rem; background:#f1f5f9; width:auto;">Reset</button></td></tr>`;
    }).join('');
}

function filterData() {
    const d = document.getElementById('fDesde').value;
    const h = document.getElementById('fHasta').value;
    if(!d && !h) { core.f = core.h.slice(0, 15); } 
    else {
        core.f = core.h.filter(x => {
            const [fecha] = x.fecha.split(' ');
            const [dia, mes, anio] = fecha.split('/');
            const itemD = new Date(anio, mes-1, dia);
            let m = true;
            if(d) m = m && (itemD >= new Date(d));
            if(h) m = m && (itemD <= new Date(h));
            return m;
        });
    }
    document.getElementById('counter').innerText = core.f.length + " registros encontrados";
    document.getElementById('hBody').innerHTML = core.f.map(x => `<tr><td>${x.fecha}</td><td><b>${x.operacion}</b></td><td>${x.prod}</td><td>${x.cant}</td><td>${x.ref}</td><td><b>${x.saldo}</b></td></tr>`).join('');
}

function clearFilter() {
    document.getElementById('fDesde').value = ""; document.getElementById('fHasta').value = ""; filterData();
}

async function doSave() {
    const b = document.getElementById('btnSave');
    const f = document.getElementById('inFecha').value;
    const m = document.getElementById('inMov').value; 
    const c = parseFloat(document.getElementById('inCant').value);
    if(!c || !f) return alert("Complete fecha y cantidad");
    let nD = core.s.d; let nG = core.s.g;
    const p = document.getElementById('inProd').value;
    if(m==='AJUSTE') { if(p==='DIESEL') nD=c; else nG=c; }
    else { if(p==='DIESEL') nD = m==='SALIDA' ? nD-c : nD+c; else nG = m==='SALIDA' ? nG-c : nG+c; }
    b.disabled = true; b.innerText = "Guardando...";
    await fetch(URL_BASE, { method:'POST', mode:'no-cors', body: JSON.stringify({ fechaManual:f, tipo:m, producto:p, cantidad:c, responsable: (m==='SALIDA'?'DESPACHO':(document.getElementById('inRef').value||'INGRESO')), stockDiesel:nD.toFixed(2), stockGasohol:nG.toFixed(2) }) });
    setTimeout(() => { fLoad(); b.disabled=false; b.innerText="Guardar Registro"; document.getElementById('inCant').value=""; setNow(); }, 1500);
}

function doExcel() {
    const ws = XLSX.utils.json_to_sheet(core.f.map(x => ({ FECHA:x.fecha, OPERACION:x.operacion, PRODUCTO:x.prod, CANTIDAD:x.cant, REFERENCIA:x.ref, SALDO:x.saldo })));
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Inventario");
    XLSX.writeFile(wb, `Reporte_ACP_${new Date().toISOString().slice(0,10)}.xlsx`);
}

function opSim() {
    document.getElementById('modSim').style.display = 'block';
    let sugD = core.s.d < 3400 ? 3000 : 0;
    document.getElementById('txtSug').innerText = sugD > 0 ? "‚ö†Ô∏è ALERTA 3,400 GL: Stock insuficiente para ma√±ana. Pedir 3,000 gl hoy." : "‚úÖ Stock de seguridad garantizado.";
    document.getElementById('pD').value = sugD; document.getElementById('pG').value = core.s.g < 400 ? 500 : 0;
}

function clSim() { document.getElementById('modSim').style.display = 'none'; }
function chIng() { document.getElementById('inExtra').style.display = document.getElementById('inMov').value === 'INGRESO' ? 'block' : 'none'; }
function reM(i) { core.m[i].u = new Date().toISOString().split('T')[0]; renderManto(); }

setNow(); fLoad(); setInterval(fLoad, 60000);
</script>
</body>
</html>
