<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CONTROL TOTAL V14 - CLEAN VERSION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; 
            --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #059669;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #334155; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1350px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; text-align: center; }
        .btn-blue { background: var(--accent); width: 100%; margin-top: 10px; }
        .btn-sim { background: #6366f1; border: 1px solid #4f46e5; }
        .btn-excel { background: #107c41; }
        
        .monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .stock-box { padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; background: #f8fafc; transition: 0.3s; }
        .stock-label { font-size: 2.2rem; font-weight: 800; display: block; margin: 10px 0; }
        .text-diesel { color: var(--diesel); }
        .text-gasohol { color: var(--gasohol); }

        .alerta-critica { background: #fee2e2 !important; border: 2px solid var(--danger) !important; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 15px; overflow-y: auto; max-height: 90vh; }
        .sim-card { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
        .badge-autonomia { background: var(--primary); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; border:none; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1 style="margin:0; font-size: 1.4rem;">‚õΩ Sistema de Control Total Pro</h1>
            <small id="statusCloud" style="color: #94a3b8;">Sincronizado con Google Sheets</small>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="abrirSimulador()" class="btn btn-sim">üìä Simulador y Autonom√≠a</button>
            <button onclick="exportarExcel()" class="btn btn-excel">üì• Reporte Excel</button>
        </div>
    </div>

    <div class="card">
        <h3>üìù Registro de Operaci√≥n</h3>
        <label>Movimiento</label>
        <select id="tipoMov" onchange="toggleCisterna()">
            <option value="salida">Salida (Consumo Diario)</option>
            <option value="ingreso">Ingreso (Cisterna / Compra)</option>
        </select>
        <label>Producto</label>
        <select id="prod">
            <option value="DIESEL">Diesel</option>
            <option value="GASOHOL">Gasohol</option>
        </select>
        <label>Cantidad (Galones)</label>
        <input type="number" id="cant" step="0.01" placeholder="0.00">
        <div id="extraData" style="display:none;">
            <label>Referencia (Placa / Factura)</label>
            <input type="text" id="referencia" placeholder="Ej: Cisterna ABC-123">
        </div>
        <button id="btnGuardar" class="btn btn-blue" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
    </div>

    <div class="card">
        <h3>üöö Monitor de Pedidos (Nube)</h3>
        <div class="monitor-grid">
            <div id="boxDiesel" class="stock-box">
                <b>Diesel Actual</b>
                <span id="sDiesel" class="stock-label text-diesel">0.00</span>
                <span id="autonomiaD" class="badge-autonomia">Cargando...</span>
            </div>
            <div id="boxGasohol" class="stock-box">
                <b>Gasohol Actual</b>
                <span id="sGasohol" class="stock-label text-gasohol">0.00</span>
                <span id="autonomiaG" class="badge-autonomia">Cargando...</span>
            </div>
        </div>
    </div>

    <div class="card full-width">
        <h3>üõ† Mantenimiento de Equipos</h3>
        <table>
            <thead>
                <tr><th>Unidad</th><th>Filtro</th><th>√öltima Fecha</th><th>D√≠as</th><th>Estado</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody id="mantoBody"></tbody>
        </table>
    </div>

    <div class="card full-width">
        <h3>üìù Historial Reciente</h3>
        <table>
            <thead>
                <tr><th>Fecha</th><th>Operaci√≥n</th><th>Producto</th><th>Cantidad</th><th>Referencia</th><th>Saldo</th></tr>
            </thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<div id="modalSimulador" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0">üìä Simulador y Orden de Pedido</h2>
            <button onclick="cerrarSimulador()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="sim-card"><b>Promedio Diario (7 d√≠as)</b><br>Diesel: <span id="pD">0</span> gl<br>Gasohol: <span id="pG">0</span> gl</div>
            <div class="sim-card" style="background:#e0f2fe;"><b>Autonom√≠a Real</b><br>Diesel: <span id="dD">0</span> d√≠as<br>Gasohol: <span id="dG">0</span> d√≠as</div>
        </div>
        <div class="sim-card" style="border:2px solid var(--gasohol); background:#f0fdf4;">
            <h3>üõí Confirmar Cantidades para Pedido</h3>
            <label>Diesel a pedir:</label><input type="number" id="pedD">
            <label>Gasohol a pedir:</label><input type="number" id="pedG">
            <button onclick="enviarPedidoCorreo()" class="btn" style="background:var(--gasohol); width:100%;">üìß Enviar Pedido (Rafael / Montenegro)</button>
            <p id="envioStatus" style="text-align:center; font-weight:bold; margin-top:10px;"></p>
        </div>
    </div>
</div>

<script>
// --- CONFIGURACI√ìN ---
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec'; 
const STOCK_CRITICO = { diesel: 2500, gasohol: 250 };

let db = {
    stockFuel: { diesel: 0, gasohol: 0 },
    historial: [],
    equipos: [
        { id: 'Surtidor 1 Diesel', f: 'CF60', ult: '2026-01-15' },
        { id: 'Surtidor 2 Diesel', f: 'CF60', ult: '2026-01-23' },
        { id: 'Hipotanque (M√≥vil)', f: 'CF100', ult: '2025-12-10' },
        { id: 'Surtidor Gasohol', f: 'MALLA', ult: '2026-01-15' }
    ]
};

// --- PROCESAMIENTO CON REDONDEO ---
function procesarMovimiento() {
    const btn = document.getElementById('btnGuardar');
    const mov = document.getElementById('tipoMov').value.toUpperCase();
    const prod = document.getElementById('prod').value;
    const cant = parseFloat(document.getElementById('cant').value);
    const ref = document.getElementById('referencia').value || "DESPACHO DIARIO";

    if (isNaN(cant) || cant <= 0) return alert("Ingrese cantidad v√°lida");

    let nD = parseFloat(db.stockFuel.diesel);
    let nG = parseFloat(db.stockFuel.gasohol);

    if (prod === 'DIESEL') {
        nD = (mov === 'SALIDA') ? nD - cant : nD + cant;
    } else {
        nG = (mov === 'SALIDA') ? nG - cant : nG + cant;
    }

    // REDONDEO A 2 DECIMALES
    nD = Math.round(nD * 100) / 100;
    nG = Math.round(nG * 100) / 100;

    if (nD < 0 || nG < 0) return alert("Error: Stock insuficiente");

    btn.disabled = true;
    btn.innerText = "Sincronizando...";

    fetch(URL_GOOGLE_SHEETS, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            tipo: mov, producto: prod, cantidad: cant, responsable: ref.toUpperCase(),
            stockDiesel: nD, stockGasohol: nG
        })
    }).then(() => {
        db.stockFuel.diesel = nD; db.stockFuel.gasohol = nG;
        actualizarUI();
        setTimeout(() => { 
            cargarDatosDesdeNube(); 
            btn.disabled = false; 
            btn.innerText = "Guardar Operaci√≥n";
            document.getElementById('cant').value = "";
        }, 2000);
    });
}

// --- LOGICA DE DATOS ---
async function cargarDatosDesdeNube() {
    try {
        const res = await fetch(URL_GOOGLE_SHEETS + '?t=' + new Date().getTime());
        const data = await response.json(); // Nota: 'response' debe ser 'res'
        if (data) {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol);
            db.historial = data.historialNube || [];
            actualizarUI(); actualizarAutonomia();
        }
    } catch (e) { 
        // Intento corregir el nombre de variable de arriba en la marcha
        fetch(URL_GOOGLE_SHEETS + '?t=' + new Date().getTime())
        .then(r => r.json())
        .then(data => {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol);
            db.historial = data.historialNube || [];
            actualizarUI(); actualizarAutonomia();
        });
    }
}

function actualizarUI() {
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);
    document.getElementById('boxDiesel').classList.toggle('alerta-critica', db.stockFuel.diesel < STOCK_CRITICO.diesel);
    document.getElementById('boxGasohol').classList.toggle('alerta-critica', db.stockFuel.gasohol < STOCK_CRITICO.gasohol);
    
    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 10).map(h => `
        <tr><td>${h.fecha}</td><td style="color:${h.mov==='INGRESO'?'green':'red'}"><b>${h.mov}</b></td>
        <td class="${h.prod==='GASOHOL'?'text-gasohol':'text-diesel'}">${h.prod}</td>
        <td>${h.cant}</td><td>${h.ref}</td><td><b>${h.saldo}</b></td></tr>`).join('');

    const hoy = new Date();
    document.getElementById('mantoBody').innerHTML = db.equipos.map((e, i) => {
        const diff = Math.floor((hoy - new Date(e.ult)) / (1000*60*60*24));
        let c = diff >= 90 ? "bg-danger" : (diff >= 80 ? "bg-warning" : "bg-success");
        return `<tr><td><b>${e.id}</b></td><td>${e.f}</td><td>${e.ult}</td><td>${diff} d</td>
        <td><span class="badge-autonomia ${c}">${diff>=90?'VENCIDO':'OK'}</span></td>
        <td><button class="btn btn-blue" style="padding:5px; margin:0; width:auto;" onclick="hacerManto(${i})">Reset</button></td></tr>`;
    }).join('');
}

function actualizarAutonomia() {
    let totalD = 0, totalG = 0;
    // Filtramos los movimientos de SALIDA de los √∫ltimos 7 d√≠as
    const salidasRecientes = db.historial.filter(h => h.mov === 'SALIDA');
    
    salidasRecientes.forEach(h => {
        if(h.prod === 'DIESEL') totalD += parseFloat(h.cant);
        else totalG += parseFloat(h.cant);
    });

    // C√ÅLCULO MEJORADO: Si hay pocos datos, usamos tus promedios reales (1700 y 165)
    // Si hay muchos datos, el sistema se adapta al promedio real del historial
    let pD = salidasRecientes.length > 3 ? (totalD / 7) : 1700; 
    let pG = salidasRecientes.length > 3 ? (totalG / 7) : 165;

    // Redondear para est√©tica
    pD = Math.max(pD, 1600); // Aseguramos un piso m√≠nimo de 1600 gl
    pG = Math.max(pG, 150);  // Aseguramos un piso m√≠nimo de 150 gl

    let dD = (db.stockFuel.diesel / pD).toFixed(1);
    let dG = (db.stockFuel.gasohol / pG).toFixed(1);

    document.getElementById('autonomiaD').innerText = dD + " d√≠as";
    document.getElementById('autonomiaG').innerText = dG + " d√≠as";
    
    return { pD, pG };
}

function abrirSimulador() {
    document.getElementById('modalSimulador').style.display = 'block';
    
    // Obtenemos los promedios calculados
    const promedios = actualizarAutonomia();
    
    document.getElementById('pD').innerText = promedios.pD.toFixed(0);
    document.getElementById('pG').innerText = promedios.pG.toFixed(0);
    
    document.getElementById('dD').innerText = (db.stockFuel.diesel / promedios.pD).toFixed(1);
    document.getElementById('dG').innerText = (db.stockFuel.gasohol / promedios.pG).toFixed(1);

    // SUGERENCIA DE PEDIDO:
    // Para 10 d√≠as de paz = (Promedio * 10) - Stock Actual
    // Diesel: (1700 * 10) = 17,000 gl... Como el tanque es de 5,000, 
    // el sistema sugerir√° llenar el tanque al m√°ximo.
    
    let sugerenciaD = Math.min(5000 - db.stockFuel.diesel, (promedios.pD * 3)); // Sugiere llenar para 3 d√≠as (capacidad tanque)
    let sugerenciaG = Math.min(1000 - db.stockFuel.gasohol, (promedios.pG * 5)); 

    document.getElementById('pedD').value = Math.max(0, sugerenciaD).toFixed(0);
    document.getElementById('pedG').value = Math.max(0, sugerenciaG).toFixed(0);
}
function abrirSimulador() {
    document.getElementById('modalSimulador').style.display = 'block';
    let totalD = 0, totalG = 0;
    db.historial.filter(h => h.mov === 'SALIDA').forEach(h => {
        if(h.prod === 'DIESEL') totalD += parseFloat(h.cant);
        else totalG += parseFloat(h.cant);
    });
    let pD = totalD / 7; let pG = totalG / 7;
    document.getElementById('pD').innerText = pD.toFixed(1);
    document.getElementById('pG').innerText = pG.toFixed(1);
    document.getElementById('dD').innerText = pD > 0 ? (db.stockFuel.diesel/pD).toFixed(1) : 0;
    document.getElementById('dG').innerText = pG > 0 ? (db.stockFuel.gasohol/pG).toFixed(1) : 0;
    document.getElementById('pedD').value = Math.max(0, (pD*10)-db.stockFuel.diesel).toFixed(0);
    document.getElementById('pedG').value = Math.max(0, (pG*10)-db.stockFuel.gasohol).toFixed(0);
}

function enviarPedidoCorreo() {
    if(!confirm("¬øEnviar pedido formal?")) return;
    const s = document.getElementById('envioStatus'); s.innerText = "Enviando...";
    fetch(URL_GOOGLE_SHEETS, { method:'POST', mode:'no-cors', body: JSON.stringify({ tipo:"PEDIDO_SIMULADO", cantidadDiesel: document.getElementById('pedD').value, cantidadGasohol: document.getElementById('pedG').value, actualD: db.stockFuel.diesel, actualG: db.stockFuel.gasohol })})
    .then(() => { s.innerText = "‚úÖ Enviado"; setTimeout(cerrarSimulador, 2000); });
}

function cerrarSimulador() { document.getElementById('modalSimulador').style.display = 'none'; }
function toggleCisterna() { document.getElementById('extraData').style.display = (document.getElementById('tipoMov').value === 'ingreso') ? 'block' : 'none'; }
function hacerManto(i) { db.equipos[i].ult = new Date().toISOString().split('T')[0]; actualizarUI(); }
function exportarExcel() { 
    const dataExcel = db.historial.map(h => ({ "FECHA": h.fecha, "MOV": h.mov, "PROD": h.prod, "CANT": h.cant, "REF": h.ref, "SALDO": h.saldo }));
    const ws = XLSX.utils.json_to_sheet(dataExcel);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Historial");
    XLSX.writeFile(wb, "Reporte_Combustible.xlsx");
}

cargarDatosDesdeNube();
setInterval(cargarDatosDesdeNube, 60000);
</script>
</body>
</html>

