<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA CONTROL V14 - ESTABLE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; --gasohol: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; padding: 15px; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 1200px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; }
        .btn-blue { background: var(--accent); width: 100%; }
        .stock-box { padding: 15px; border-radius: 10px; text-align: center; background: #f8fafc; border: 1px solid #e2e8f0; }
        .stock-label { font-size: 2rem; font-weight: 800; display: block; }
        .alerta-critica { background: #fee2e2 !important; border: 2px solid var(--danger) !important; color: var(--danger) !important; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.8); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 600px; border-radius: 15px; }
        input, select { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; display:flex; justify-content:space-between; align-items:center; border:none;">
        <div><h2 style="margin:0">‚õΩ Control Grupo ACP</h2><small id="statusCloud">Conectando...</small></div>
        <div style="display:flex; gap:10px;">
            <button onclick="abrirSimulador()" class="btn" style="background:#6366f1">üìä Simulador</button>
            <button onclick="exportarExcel()" class="btn" style="background:#107c41">üì• Excel</button>
        </div>
    </div>

    <div class="card">
        <h3>üìù Registro</h3>
        <select id="tipoMov" onchange="toggleRef()"><option value="salida">SALIDA</option><option value="ingreso">INGRESO</option></select>
        <select id="prod"><option value="DIESEL">DIESEL</option><option value="GASOHOL">GASOHOL</option></select>
        <input type="number" id="cant" placeholder="Cantidad gl">
        <input type="text" id="referencia" placeholder="Placa / Factura" style="display:none;">
        <button id="btnGuardar" class="btn btn-blue" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
    </div>

    <div class="card">
        <h3>üöö Stock Actual</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div id="boxD" class="stock-box"><b>Diesel</b><span id="sDiesel" class="stock-label text-diesel">0</span></div>
            <div id="boxG" class="stock-box"><b>Gasohol</b><span id="sGasohol" class="stock-label text-gasohol">0</span></div>
        </div>
    </div>

    <div class="card full-width"><h3>üìà Consumo 7 D√≠as</h3><canvas id="consumoChart" height="100"></canvas></div>

    <div class="card full-width">
        <h3>üìù Historial</h3>
        <table>
            <thead><tr><th>Fecha</th><th>Mov</th><th>Producto</th><th>Cant</th><th>Saldo</th></tr></thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<div id="modalSimulador" class="modal">
    <div class="modal-content">
        <h2>üìä Simulador de Pedido</h2>
        <div id="simResumen" style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:15px;"></div>
        <label>Diesel a pedir:</label><input type="number" id="pedD">
        <label>Gasohol a pedir:</label><input type="number" id="pedG">
        <button onclick="enviarPedidoCorreo()" class="btn" style="background:#059669; width:100%;">üìß Enviar a Rafael / Montenegro</button>
        <button onclick="cerrarSimulador()" class="btn" style="background:#94a3b8; width:100%; margin-top:5px;">Cerrar</button>
    </div>
</div>

<script>
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec';
let db = { stockFuel: { diesel: 0, gasohol: 0 }, historial: [] };
let chartObj;

async function cargarDatosDesdeNube() {
    try {
        const res = await fetch(URL_GOOGLE_SHEETS + '?t=' + new Date().getTime());
        const data = await res.json();
        if (data) {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol);
            db.historial = data.historialNube || [];
            actualizarUI(); actualizarGrafico();
            document.getElementById('statusCloud').innerText = "‚úÖ Sincronizado";
        }
    } catch (e) { document.getElementById('statusCloud').innerText = "‚ö†Ô∏è Error de red"; }
}

function procesarMovimiento() {
    // ... (obtenci√≥n de datos de inputs)
    
    let nD = parseFloat(db.stockFuel.diesel);
    let nG = parseFloat(db.stockFuel.gasohol);

    if (prod === 'DIESEL') {
        nD = (mov === 'SALIDA') ? nD - cant : nD + cant;
    } else {
        nG = (mov === 'SALIDA') ? nG - cant : nG + cant;
    }

    // REDONDEO MATEM√ÅTICO A 2 DECIMALES
    nD = Math.round(nD * 100) / 100;
    nG = Math.round(nG * 100) / 100;

    // ... (resto del fetch a Google Sheets)
}
function actualizarUI() {
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);
    document.getElementById('boxD').classList.toggle('alerta-critica', db.stockFuel.diesel < 2500);
    document.getElementById('boxG').classList.toggle('alerta-critica', db.stockFuel.gasohol < 250);
    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 8).map(h => `<tr><td>${h.fecha.split(' ')[0]}</td><td>${h.mov}</td><td>${h.prod}</td><td>${h.cant}</td><td>${h.saldo}</td></tr>`).join('');
}

function actualizarGrafico() {
    const ctx = document.getElementById('consumoChart').getContext('2d');
    const diasLabels = [];
    const hoy = new Date();

    // Generar etiquetas de los √∫ltimos 7 d√≠as (DD/MM)
    for (let i = 6; i >= 0; i--) {
        let d = new Date();
        d.setDate(hoy.getDate() - i);
        diasLabels.push(d.toLocaleDateString('es-PE').substring(0, 5)); 
    }

    // Procesar consumos (Solo SALIDAS)
    const dataD = diasLabels.map(label => {
        return db.historial
            .filter(h => h.fecha.includes(label) && h.mov === 'SALIDA' && h.prod === 'DIESEL')
            .reduce((acc, curr) => acc + parseFloat(curr.cant || 0), 0);
    });

    const dataG = diasLabels.map(label => {
        return db.historial
            .filter(h => h.fecha.includes(label) && h.mov === 'SALIDA' && h.prod === 'GASOHOL')
            .reduce((acc, curr) => acc + parseFloat(curr.cant || 0), 0);
    });

    if(chartObj) chartObj.destroy();
    
    chartObj = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: diasLabels,
            datasets: [
                { label: 'Diesel', data: dataD, backgroundColor: '#2563eb' },
                { label: 'Gasohol', data: dataG, backgroundColor: '#10b981' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // CLAVE: evita que la gr√°fica crezca infinitamente
            scales: {
                y: { 
                    beginAtZero: true,
                    // Si el consumo m√°s alto es 3000, la gr√°fica llegar√° a 3500 para dejar aire arriba
                    suggestedMax: Math.max(...dataD, ...dataG) * 1.2 
                }
            },
            plugins: {
                legend: { position: 'top' }
            }
        }
    });
}
function abrirSimulador() {
    document.getElementById('modalSimulador').style.display = 'block';
    let tD = db.historial.filter(h=>h.mov==='SALIDA'&&h.prod==='DIESEL').reduce((a,b)=>a+parseFloat(b.cant),0)/7;
    let tG = db.historial.filter(h=>h.mov==='SALIDA'&&h.prod==='GASOHOL').reduce((a,b)=>a+parseFloat(b.cant),0)/7;
    document.getElementById('simResumen').innerHTML = `<b>Promedio Diario:</b><br>Diesel: ${tD.toFixed(1)} gl | Gasohol: ${tG.toFixed(1)} gl<br><b>Autonom√≠a:</b> Diesel ${(db.stockFuel.diesel/(tD||1)).toFixed(1)} d√≠as.`;
    document.getElementById('pedD').value = Math.max(0, (tD*10)-db.stockFuel.diesel).toFixed(0);
    document.getElementById('pedG').value = Math.max(0, (tG*10)-db.stockFuel.gasohol).toFixed(0);
}

function enviarPedidoCorreo() {
    fetch(URL_GOOGLE_SHEETS, { method:'POST', mode:'no-cors', body: JSON.stringify({ tipo:"PEDIDO_SIMULADO", cantidadDiesel: document.getElementById('pedD').value, cantidadGasohol: document.getElementById('pedG').value, actualD: db.stockFuel.diesel, actualG: db.stockFuel.gasohol })})
    .then(() => { alert("Pedido enviado"); cerrarSimulador(); });
}

function cerrarSimulador() { document.getElementById('modalSimulador').style.display = 'none'; }
function toggleRef() { document.getElementById('referencia').style.display = (document.getElementById('tipoMov').value === 'ingreso') ? 'block' : 'none'; }
function exportarExcel() { /* L√≥gica est√°ndar */ }

cargarDatosDesdeNube(); setInterval(cargarDatosDesdeNube, 60000);
</script>
</body>
</html>





