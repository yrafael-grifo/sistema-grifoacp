<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CONTROL TOTAL V14 - FULL HISTORIAL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; 
            --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #059669;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #334155; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1350px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; text-align: center; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-excel { background: #107c41; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .status-badge { padding: 5px 10px; border-radius: 6px; font-size: 0.85em; font-weight: bold; }
        .bg-danger { background: #fee2e2; color: var(--danger); border: 1px solid var(--danger); }
        .bg-success { background: #dcfce7; color: var(--gasohol); }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .stock-label { font-size: 1.8rem; font-weight: bold; display: block; margin: 5px 0; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; border:none; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">‚õΩ Control de Suministro Pro (Reserva 24h)</h1>
            <small id="statusCloud" style="color: #94a3b8;">Sincronizaci√≥n Cloud Activa</small>
        </div>
        <button onclick="exportarExcel()" class="btn btn-excel">üì• Descargar Reporte EXCEL (.xlsx)</button>
    </div>

    <div class="card">
        <h2>üìë Registro de Operaci√≥n</h2>
        <label>Tipo de Movimiento</label>
        <select id="tipoMov" onchange="toggleCisterna()">
            <option value="salida">Salida (Consumo Diario)</option>
            <option value="ingreso">Ingreso (Cisterna / Compra)</option>
        </select>
        <label>Producto</label>
        <select id="prod">
            <option value="diesel">Diesel (Cap: 5000 gl)</option>
            <option value="gasohol">Gasohol (Cap: 1000 gl)</option>
        </select>
        <label>Cantidad (Galones)</label>
        <input type="number" id="cant" step="0.01" placeholder="0.00">
        
        <div id="extraData" style="display:none;">
            <label>Referencia (Placa/Chofer/Factura)</label>
            <input type="text" id="referencia" placeholder="Ej: Cisterna ABC-123">
        </div>
        
        <button class="btn btn-blue" style="width:100%" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
        
        <h3 style="margin-top:20px;">üì¶ Reposici√≥n de Filtros</h3>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-green" style="flex:1" onclick="reponerFiltro('cf60')">Comprar CF60</button>
            <button class="btn btn-green" style="flex:1" onclick="reponerFiltro('cf100')">Comprar CF100</button>
        </div>
    </div>

    <div class="card">
        <h2>üöö Monitor de Pedidos (Reserva 24h)</h2>
        <div id="alertasContainer"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top:10px;">
            <div class="status-badge bg-success" style="text-align:center; padding:15px; border:1px solid #10b981">
                <b>Diesel Actual</b>
                <span id="sDiesel" class="stock-label">0</span>
                <small>Reserva: 3000 gl</small>
            </div>
            <div class="status-badge bg-success" style="text-align:center; padding:15px; border:1px solid #10b981">
                <b>Gasohol Actual</b>
                <span id="sGasohol" class="stock-label">0</span>
                <small>Reserva: 450 gl</small>
            </div>
        </div>
        <div style="margin-top:20px; padding: 12px; background: #f8fafc; border-radius: 8px;">
            <b>Inventario de Filtros:</b><br>
            CF60: <span id="f60" style="font-weight:bold">3</span> | CF100: <span id="f100" style="font-weight:bold">2</span>
            <div id="alertaFiltros"></div>
        </div>
    </div>

    <div class="card full-width">
        <h2>üõ† Plan de Mantenimiento y Filtros (Ciclo 90 d√≠as)</h2>
        <table>
            <thead>
                <tr><th>Unidad</th><th>Filtro</th><th>√öltima Fecha</th><th>D√≠as Pasados</th><th>Estado</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody id="mantoBody"></tbody>
        </table>
    </div>

    <div class="card full-width">
        <h2>üìù Historial de Ingresos y Salidas</h2>
        <table>
            <thead>
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Operaci√≥n</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Referencia</th>
                    <th>Saldo Final</th>
                </tr>
            </thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<script>
// --- CONFIGURACI√ìN CLOUD CORREGIDA ---
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec'; 

function enviarANube(datos) {
    if (!URL_GOOGLE_SHEETS || URL_GOOGLE_SHEETS.includes('AQUI')) return;
    const status = document.getElementById('statusCloud');
    if (status) status.innerText = "‚òÅÔ∏è Sincronizando...";
    
    fetch(URL_GOOGLE_SHEETS, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            tipo: datos.mov,
            cantidad: datos.cant + " (" + datos.prod + ")",
            responsable: datos.ref,
            stock: datos.saldo
        })
    }).then(() => {
        if (status) {
            status.innerText = "‚úÖ Sincronizado";
            status.style.color = "#10b981";
        }
    }).catch((error) => {
        console.error("Error Cloud:", error);
        if (status) {
            status.innerText = "‚ùå Error de conexi√≥n";
            status.style.color = "#ef4444";
        }
    });
}

const CAP = { diesel: 5000, gasohol: 1000 };
const STOCK_CRITICO = { diesel: 3000, gasohol: 450 };
const DIAS_LIMITE = 90;

let db = JSON.parse(localStorage.getItem('fuel_v14_final')) || {
    stockFuel: { diesel: 5000, gasohol: 1000 },
    stockFiltros: { cf60: 3, cf100: 2 }, 
    historial: [],
    equipos: [
        { id: 'Surtidor 1 Diesel', f: 'CF60', ult: '2026-01-15' },
        { id: 'Surtidor 2 Diesel', f: 'CF60', ult: '2026-01-23' },
        { id: 'Hipotanque (M√≥vil)', f: 'CF100', ult: '2025-12-10' },
        { id: 'Surtidor Gasohol', f: 'MALLA', ult: '2026-01-15' }
    ]
};

function toggleCisterna() {
    document.getElementById('extraData').style.display = (document.getElementById('tipoMov').value === 'ingreso') ? 'block' : 'none';
}

function procesarMovimiento() {
    const mov = document.getElementById('tipoMov').value;
    const prod = document.getElementById('prod').value;
    const cant = parseFloat(document.getElementById('cant').value);
    const ref = document.getElementById('referencia').value || (mov === 'salida' ? 'DESPACHO DIARIO' : 'INGRESO CISTERNA');

    if (isNaN(cant) || cant <= 0) return alert("Cantidad inv√°lida");

    if (mov === 'salida') {
        if (db.stockFuel[prod] < cant) return alert("Stock insuficiente");
        db.stockFuel[prod] = Number((db.stockFuel[prod] - cant).toFixed(2));
    } else {
        if ((db.stockFuel[prod] + cant) > (CAP[prod] + 0.1)) return alert("Excede capacidad");
        db.stockFuel[prod] = Number((db.stockFuel[prod] + cant).toFixed(2));
    }

    const nuevaOp = {
        fecha: new Date().toLocaleString(),
        mov: mov.toUpperCase(),
        prod: prod.toUpperCase(),
        cant: cant.toFixed(2),
        ref: ref.toUpperCase(),
        saldo: db.stockFuel[prod]
    };

    db.historial.unshift(nuevaOp);

    // Enviar a la nube
    enviarANube(nuevaOp);

    actualizarUI();
    document.getElementById('cant').value = "";
    document.getElementById('referencia').value = "";
}

function reponerFiltro(t) {
    db.stockFiltros[t]++;
    actualizarUI();
}

function actualizarUI() {
    localStorage.setItem('fuel_v14_final', JSON.stringify(db));
    
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);
    document.getElementById('f60').innerText = db.stockFiltros.cf60;
    document.getElementById('f100').innerText = db.stockFiltros.cf100;

    let alerts = "";
    if(db.stockFuel.diesel <= STOCK_CRITICO.diesel) alerts += `<div class="bg-danger" style="padding:10px; border-radius:8px; margin-bottom:8px;">‚ö†Ô∏è <b>DIESEL CR√çTICO:</b> Realizar pedido HOY.</div>`;
    if(db.stockFuel.gasohol <= STOCK_CRITICO.gasohol) alerts += `<div class="bg-danger" style="padding:10px; border-radius:8px; margin-bottom:8px;">‚ö†Ô∏è <b>GASOHOL CR√çTICO:</b> Realizar pedido HOY.</div>`;
    document.getElementById('alertasContainer').innerHTML = alerts || "‚úÖ Stock con margen 24h OK.";

    let fAlert = "";
    if(db.stockFiltros.cf60 <= 2) fAlert += `<p class="status-badge bg-danger">‚ö†Ô∏è Reponer Filtros CF60</p>`;
    if(db.stockFiltros.cf100 <= 1) fAlert += `<p class="status-badge bg-danger">‚ö†Ô∏è Reponer Filtros CF100</p>`;
    document.getElementById('alertaFiltros').innerHTML = fAlert;

    const hoy = new Date();
    document.getElementById('mantoBody').innerHTML = db.equipos.map((e, i) => {
        const diff = Math.floor((hoy - new Date(e.ult)) / (1000*60*60*24));
        let c = diff >= DIAS_LIMITE ? "bg-danger" : (diff >= 80 ? "bg-warning" : "bg-success");
        return `<tr><td><b>${e.id}</b></td><td><code>${e.f}</code></td><td>${e.ult}</td><td>${diff} d√≠as</td>
        <td><span class="status-badge ${c}">${diff>=90?'VENCIDO':'OK'}</span></td>
        <td><button class="btn btn-blue btn-sm" onclick="hacerManto(${i})">Reset</button></td></tr>`;
    }).join('');

    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 15).map(h => `
        <tr>
            <td>${h.fecha}</td>
            <td style="color:${h.mov==='INGRESO'?'green':'red'}"><b>${h.mov}</b></td>
            <td>${h.prod}</td>
            <td>${h.cant}</td>
            <td>${h.ref}</td>
            <td><b>${h.saldo}</b></td>
        </tr>
    `).join('');
}

function hacerManto(i) {
    const e = db.equipos[i];
    if(e.f.startsWith('CF')) {
        const fKey = e.f.toLowerCase();
        if(db.stockFiltros[fKey] <= 0) return alert("Sin filtros en stock.");
        if(confirm(`¬øDescontar 1 filtro ${e.f}?`)) {
            db.stockFiltros[fKey]--;
            db.equipos[i].ult = new Date().toISOString().split('T')[0];
        }
    } else if(confirm("¬øConfirmar mantenimiento?")) {
        db.equipos[i].ult = new Date().toISOString().split('T')[0];
    }
    actualizarUI();
}

function exportarExcel() {
    // 1. Preparamos los datos transformando las llaves (encabezados) a MAY√öSCULAS
    const historialMayusculas = db.historial.map(registro => {
        return {
            "FECHA Y HORA": registro.fecha,
            "OPERACI√ìN": registro.mov,
            "PRODUCTO": registro.prod,
            "CANTIDAD (GL)": registro.cant,
            "REFERENCIA": registro.ref,
            "SALDO FINAL": registro.saldo
        };
    });

    // 2. Creamos el libro y la hoja de trabajo
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(historialMayusculas);

    // 3. A√±adimos la hoja al libro
    XLSX.utils.book_append_sheet(wb, ws, "Historial_Combustible");

    // 4. Descargamos el archivo
    XLSX.writeFile(wb, "Reporte_Combustible_Pro.xlsx");
}

actualizarUI();
</script>
</body>

</html>
