<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CONTROL ACP - DASHBOARD OPERATIVO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root {
--bg: #f8fafc; --card: #ffffff; --primary: #0f172a; --accent: #3b82f6;
--diesel: #2563eb; --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #22c55e;
--text-main: #1e293b; --text-muted: #64748b;
}
body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 20px; line-height: 1.5; }
.container { max-width: 1400px; margin: auto; display: grid; grid-template-columns: repeat(12, 1fr); gap: 24px; }

    /* HEADER */
    .header { grid-column: span 12; display: flex; justify-content: space-between; align-items: center; background: var(--primary); padding: 20px 32px; border-radius: 16px; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    .header h2 { margin: 0; font-size: 1.5rem; letter-spacing: -0.5px; }
    .status-pill { background: rgba(255,255,255,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; }

    /* CARDS */
    .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
    .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 20px; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    
    /* MONITOR STOCK */
    .stock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .stock-item { padding: 20px; border-radius: 14px; border: 2px solid #f1f5f9; text-align: center; transition: all 0.3s ease; }
    .stock-item b { color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
    .val { font-size: 2.5rem; font-weight: 800; display: block; margin: 10px 0; font-variant-numeric: tabular-nums; }
    .autonomia { display: inline-block; padding: 4px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; background: #f1f5f9; }

    /* SEMAFORO EST√âTICO */
    .sem-ok { border-color: var(--success); background: #f0fdf4; }
    .sem-alert { border-color: var(--warning); background: #fffbeb; }
    .sem-crit { border-color: var(--danger); background: #fef2f2; animation: pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

    /* FORMS */
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; color: var(--text-muted); }
    select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #cbd5e1; font-size: 1rem; transition: border 0.2s; box-sizing: border-box; }
    select:focus, input:focus { outline: none; border-color: var(--accent); ring: 2px rgba(59, 130, 246, 0.2); }

    /* BUTTONS */
    .btn { cursor: pointer; padding: 12px 20px; border: none; border-radius: 10px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-primary { background: var(--accent); color: white; width: 100%; }
    .btn-primary:hover { background: #2563eb; transform: translateY(-1px); }
    .btn-ghost { background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); }
    .btn-ghost:hover { background: rgba(255,255,255,0.2); }

    /* TABLES */
    table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; }
    th { background: #f8fafc; padding: 12px 16px; text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid #e2e8f0; }
    td { padding: 16px; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }
    tr:hover td { background: #f8fafc; }
    .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 700; }

    /* MODAL */
    .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15,23,42,0.6); backdrop-filter: blur(4px); }
    .modal-content { background: white; margin: 5vh auto; padding: 32px; width: 90%; max-width: 600px; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

    /* RESPONSIVE */
    .col-4 { grid-column: span 4; }
    .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }
    @media (max-width: 1024px) { .col-4, .col-8 { grid-column: span 12; } }
</style>
</head>
<body>

<div class="container">
<div class="header">
<div>
<h2>‚õΩ Grupo ACP</h2>
<div class="status-pill"><div class="dot"></div> <span id="cloudStatus">Sincronizando base de datos...</span></div>
</div>
<div style="display:flex; gap:12px;">
<button onclick="openSim()" class="btn btn-ghost">üìä Simulador</button>
<button onclick="exportXLS()" class="btn btn-ghost" style="border-color:#22c55e66">üì• Descargar Excel</button>
</div>
</div>

<div class="card col-4">
    <div class="card-title">üìù Registro de Operaci√≥n</div>
    <div class="form-group">
        <label>Tipo de Movimiento</label>
        <select id="tMov" onchange="checkIng()"><option value="salida">Despacho (Salida)</option><option value="ingreso">Reabastecimiento (Ingreso)</option></select>
    </div>
    <div class="form-group">
        <label>Producto</label>
        <select id="tProd"><option value="DIESEL">Diesel B5 S50</option><option value="GASOHOL">Gasohol Regular</option></select>
    </div>
    <div class="form-group">
        <label>Cantidad (Galones)</label>
        <input type="number" id="tCant" placeholder="0.00">
    </div>
    <div id="extra" style="display:none;" class="form-group">
        <label>Referencia (Placa / Factura)</label>
        <input type="text" id="tRef" placeholder="Ej: ABC-123">
    </div>
    <button id="btnSave" class="btn btn-primary" onclick="saveData()">Registrar Operaci√≥n</button>
</div>

<div class="card col-8">
    <div class="card-title">üöö Monitor de Inventario Real</div>
    <div class="stock-grid">
        <div id="bD" class="stock-item">
            <b>Diesel B5 S50</b>
            <span id="vD" class="val" style="color:var(--diesel)">0.00</span>
            <div id="aD" class="autonomia">---</div>
        </div>
        <div id="bG" class="stock-item">
            <b>Gasohol Regular</b>
            <span id="vG" class="val" style="color:var(--gasohol)">0.00</span>
            <div id="aG" class="autonomia">---</div>
        </div>
    </div>
</div>

<div class="card col-12">
    <div class="card-title">üõ† Estado de Surtidores y Filtros</div>
    <table>
        <thead><tr><th>Equipo</th><th>Filtro</th><th>√öltima Fecha</th><th>D√≠as Transcurridos</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
        <tbody id="mantoBody"></tbody>
    </table>
</div>

<div class="card col-12">
    <div class="card-title">üìù Historial de Movimientos Recientes</div>
    <table>
        <thead><tr><th>Fecha / Hora</th><th>Tipo</th><th>Producto</th><th>Cantidad</th><th>Saldo Final</th></tr></thead>
        <tbody id="histBody"></tbody>
    </table>
</div>
</div>

<div id="mSim" class="modal">
<div class="modal-content">
<h2 style="margin-top:0">üìä An√°lisis de Reposici√≥n</h2>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px;">
<div style="background:#f8fafc; padding:16px; border-radius:12px; border:1px solid #e2e8f0;">
<label>Consumo Diario Est.</label>
<div style="font-size:0.9rem"><b>Diesel:</b> 1,700 gl</div>
<div style="font-size:0.9rem"><b>Gasohol:</b> 165 gl</div>
</div>
<div style="background:#eff6ff; padding:16px; border-radius:12px; border:1px solid #bfdbfe;">
<label>Autonom√≠a Actual</label>
<div style="font-size:0.9rem"><b>Diesel:</b> <span id="sD">0</span> d√≠as</div>
<div style="font-size:0.9rem"><b>Gasohol:</b> <span id="sG">0</span> d√≠as</div>
</div>
</div>
<div style="background:#f0f9ff; padding:20px; border-radius:16px; border:2px solid var(--accent);">
<div id="txtSug" style="font-weight:700; color:var(--primary); margin-bottom:15px;"></div>
<div class="form-group"><label>Diesel a pedir</label><input type="number" id="pD"></div>
<div class="form-group"><label>Gasohol a pedir</label><input type="number" id="pG"></div>
<button onclick="sendMail()" class="btn btn-primary" style="background:var(--primary)">üìß Enviar Pedido a Log√≠stica</button>
<p id="mailStatus" style="text-align:center; margin-top:12px; font-weight:600;"></p>
</div>
<button onclick="closeSim()" class="btn" style="background:#f1f5f9; color:var(--text-main); margin-top:16px; width:100%">Cerrar Ventana</button>
</div>
</div>

<script>
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec';
let core = { stock: { d: 0, g: 0 }, hist: [], units: [{id:'Surtidor 1', f:'CF60', u:'2026-01-15'},{id:'Surtidor 2', f:'CF60', u:'2026-01-23'},{id:'Hipotanque', f:'CF100', u:'2025-12-10'},{id:'Gasohol', f:'MALLA', u:'2026-01-15'}] };

async function loadData() {
try {
const r = await fetch(URL_SCRIPT + '?t=' + new Date().getTime());
const d = await r.json();
core.stock.d = parseFloat(d.ultimoDiesel);
core.stock.g = parseFloat(d.ultimoGasohol);
core.hist = d.historialNube || [];
render();
document.getElementById('cloudStatus').innerText = "Sistema Sincronizado";
} catch (e) { document.getElementById('cloudStatus').innerText = "Error de conexi√≥n"; }
}

function render() {
const aD = (core.stock.d / 1700).toFixed(1);
const aG = (core.stock.g / 165).toFixed(1);
document.getElementById('vD').innerText = core.stock.d.toLocaleString('en-US', {minimumFractionDigits: 2});
document.getElementById('vG').innerText = core.stock.g.toLocaleString('en-US', {minimumFractionDigits: 2});
document.getElementById('aD').innerText = aD + " d√≠as de stock";
document.getElementById('aG').innerText = aG + " d√≠as de stock";

const bD = document.getElementById(&#39;bD&#39;); bD.className = &#39;stock-item&#39;;
if(aD &lt; 1.0) bD.classList.add(&#39;sem-crit&#39;); else if(aD &lt; 2.0) bD.classList.add(&#39;sem-alert&#39;); else bD.classList.add(&#39;sem-ok&#39;);

const bG = document.getElementById(&#39;bG&#39;); bG.className = &#39;stock-item&#39;;
if(aG &lt; 1.5) bG.classList.add(&#39;sem-crit&#39;); else if(aG &lt; 3.0) bG.classList.add(&#39;sem-alert&#39;); else bG.classList.add(&#39;sem-ok&#39;);

const hoy = new Date();
document.getElementById(&#39;mantoBody&#39;).innerHTML = core.units.map((u, i) =&gt; {
    const diff = Math.floor((hoy - new Date(u.u)) / 86400000);
    let color = diff &gt;= 90 ? &#39;var(--danger)&#39; : (diff &gt;= 80 ? &#39;var(--warning)&#39; : &#39;var(--success)&#39;);
    return `&lt;tr&gt;&lt;td&gt;&lt;b&gt;${u.id}&lt;/b&gt;&lt;/td&gt;&lt;td&gt;&lt;code&gt;${u.f}&lt;/code&gt;&lt;/td&gt;&lt;td&gt;${u.u}&lt;/td&gt;&lt;td&gt;${diff} d√≠as&lt;/td&gt;
    &lt;td&gt;&lt;span class=&quot;badge&quot; style=&quot;background:${color}22; color:${color}&quot;&gt;${diff&gt;=90?&#39;VENCIDO&#39;:&#39;OPTIMO&#39;}&lt;/span&gt;&lt;/td&gt;
    &lt;td&gt;&lt;button class=&quot;btn&quot; style=&quot;padding:4px 10px; font-size:0.7rem; background:#f1f5f9; width:auto;&quot; onclick=&quot;resetManto(${i})&quot;&gt;Reset&lt;/button&gt;&lt;/td&gt;&lt;/tr&gt;`;
}).join(&#39;&#39;);

document.getElementById(&#39;histBody&#39;).innerHTML = core.hist.slice(0,10).map(h =&gt; {
    let color = h.mov === &#39;INGRESO&#39; ? &#39;var(--success)&#39; : &#39;var(--text-main)&#39;;
    return `&lt;tr&gt;&lt;td&gt;${h.fecha}&lt;/td&gt;&lt;td&gt;&lt;span class=&quot;badge&quot; style=&quot;background:#f1f5f9&quot;&gt;${h.mov}&lt;/span&gt;&lt;/td&gt;
    &lt;td&gt;${h.prod}&lt;/td&gt;&lt;td style=&quot;color:${color}; font-weight:700&quot;&gt;${h.cant}&lt;/td&gt;&lt;td&gt;&lt;b&gt;${h.saldo}&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;`;
}).join(&#39;&#39;);
}

function saveData() {
const btn = document.getElementById('btnSave');
const m = document.getElementById('tMov').value.toUpperCase();
const p = document.getElementById('tProd').value;
const c = parseFloat(document.getElementById('tCant').value);
const r = document.getElementById('tRef').value || "OPERACION";
if(!c || c <= 0) return alert("Por favor ingrese una cantidad v√°lida");

let nD = core.stock.d; let nG = core.stock.g;
if(p === &#39;DIESEL&#39;) nD = m === &#39;SALIDA&#39; ? nD - c : nD + c; else nG = m === &#39;SALIDA&#39; ? nG - c : nG + c;

btn.disabled = true; btn.innerText = &quot;Procesando...&quot;;
fetch(URL_SCRIPT, { method: &#39;POST&#39;, mode: &#39;no-cors&#39;, body: JSON.stringify({ tipo: m, producto: p, cantidad: c, responsable: r, stockDiesel: nD.toFixed(2), stockGasohol: nG.toFixed(2) }) })
.then(() =&gt; { 
    core.stock.d = nD; core.stock.g = nG; render(); 
    setTimeout(() =&gt; { loadData(); btn.disabled = false; btn.innerText = &quot;Registrar Operaci√≥n&quot;; document.getElementById(&#39;tCant&#39;).value = &quot;&quot;; }, 1500); 
});
}

function openSim() {
document.getElementById('mSim').style.display = 'block';
const sD = core.stock.d; const sG = core.stock.g;
document.getElementById('sD').innerText = (sD / 1700).toFixed(1);
document.getElementById('sG').innerText = (sG / 165).toFixed(1);
let sugD = sD < 3400 ? 3000 : 0;
let sugG = sG < 400 ? 500 : 0;
let txt = sugD > 0 || sugG > 0 ? "‚ö†Ô∏è SE RECOMIENDA REABASTECIMIENTO" : "‚úÖ NIVELES DE STOCK SEGUROS";
document.getElementById('txtSug').innerText = txt;
document.getElementById('pD').value = sugD;
document.getElementById('pG').value = sugG;
}

function sendMail() {
const s = document.getElementById('mailStatus');
s.innerText = "‚è≥ Enviando comunicaci√≥n..."; s.style.color = "var(--accent)";
fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tipo: "PEDIDO_SIMULADO", cantidadDiesel: document.getElementById('pD').value, cantidadGasohol: document.getElementById('pG').value, actualD: core.stock.d, actualG: core.stock.g }) })
.then(() => { s.innerText = "‚úÖ Pedido enviado exitosamente"; setTimeout(closeSim, 2000); });
}

function exportXLS() {
const ws = XLSX.utils.json_to_sheet(core.hist);
const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Inventario");
XLSX.writeFile(wb, "Control_Combustible_ACP.xlsx");
}

function closeSim() { document.getElementById('mSim').style.display = 'none'; }
function checkIng() { document.getElementById('extra').style.display = document.getElementById('tMov').value === 'ingreso' ? 'block' : 'none'; }
function resetManto(i) { core.units[i].u = new Date().toISOString().split('T')[0]; render(); }

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
