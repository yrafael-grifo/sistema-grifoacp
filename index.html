<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CONTROL TOTAL V14 - ANALYTICS PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #1e293b; --accent: #3b82f6; --diesel: #2563eb; 
            --gasohol: #10b981; --danger: #ef4444; --warning: #f59e0b; --success: #059669;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; margin: 0; padding: 20px; color: #334155; }
        .dashboard { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1350px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--accent); }
        .full-width { grid-column: span 2; }
        
        .btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; transition: 0.2s; text-align: center; }
        .btn-blue { background: var(--accent); width: 100%; margin-top: 10px; }
        .btn-sim { background: #6366f1; border: 1px solid #4f46e5; }
        .btn-excel { background: #107c41; }
        
        .monitor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .stock-box { padding: 20px; border-radius: 10px; text-align: center; border: 1px solid #e2e8f0; background: #f8fafc; }
        .stock-label { font-size: 2.2rem; font-weight: 800; display: block; margin: 10px 0; }
        .text-diesel { color: var(--diesel); }
        .text-gasohol { color: var(--gasohol); }

        .alerta-roja { background: #fee2e2 !important; border: 1px solid var(--danger) !important; color: var(--danger); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9em; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .modal-content { background: white; margin: 2% auto; padding: 30px; width: 90%; max-width: 800px; border-radius: 15px; overflow-y: auto; max-height: 90vh; }
        
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="card full-width" style="background: var(--primary); color: white; border:none; display:flex; justify-content:space-between; align-items:center;">
        <div>
            <h1 style="margin:0; font-size: 1.4rem;">‚õΩ Sistema de Control Pro - Grupo ACP</h1>
            <small id="statusCloud" style="color: #94a3b8;">Sincronizado con Google Sheets</small>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="abrirSimulador()" class="btn btn-sim">üìä Simulador y Autonom√≠a</button>
            <button onclick="exportarExcel()" class="btn btn-excel">üì• Reporte Excel</button>
        </div>
    </div>

    <div class="card">
        <h3>üöö Monitor de Pedidos (Nube)</h3>
        <div class="monitor-grid">
            <div id="boxD" class="stock-box">
                <b>Diesel Actual</b>
                <span id="sDiesel" class="stock-label text-diesel">0.00</span>
                <small id="alertD" style="display:none; color:red; font-weight:bold;">üö® REPOSICI√ìN URGENTE</small>
            </div>
            <div id="boxG" class="stock-box">
                <b>Gasohol Actual</b>
                <span id="sGasohol" class="stock-label text-gasohol">0.00</span>
                <small id="alertG" style="display:none; color:red; font-weight:bold;">üö® REPOSICI√ìN URGENTE</small>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üìà Consumo Semanal (Galones)</h3>
        <canvas id="chartConsumo" height="150"></canvas>
    </div>

    <div class="card">
        <h3>üìù Registro de Operaci√≥n</h3>
        <label>Movimiento</label>
        <select id="tipoMov" onchange="toggleCisterna()">
            <option value="salida">Salida (Consumo Diario)</option>
            <option value="ingreso">Ingreso (Cisterna / Compra)</option>
        </select>
        <label>Producto</label>
        <select id="prod">
            <option value="DIESEL">Diesel</option>
            <option value="GASOHOL">Gasohol</option>
        </select>
        <label>Cantidad (Galones)</label>
        <input type="number" id="cant" step="0.01" placeholder="0.00">
        <div id="extraData" style="display:none;">
            <label>Referencia (Placa / Factura)</label>
            <input type="text" id="referencia" placeholder="Ej: Cisterna ABC-123">
        </div>
        <button class="btn btn-blue" onclick="procesarMovimiento()">Guardar Operaci√≥n</button>
    </div>

    <div class="card full-width">
        <h3>üìù Historial Reciente</h3>
        <table>
            <thead>
                <tr><th>Fecha</th><th>Operaci√≥n</th><th>Producto</th><th>Cantidad</th><th>Referencia</th><th>Saldo</th></tr>
            </thead>
            <tbody id="historialBody"></tbody>
        </table>
    </div>
</div>

<script>
const URL_GOOGLE_SHEETS = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec'; 

const STOCK_CRITICO = { diesel: 2500, gasohol: 250 };
let db = { stockFuel: { diesel: 0, gasohol: 0 }, historial: [] };
let consumoChart;

async function cargarDatosDesdeNube() {
    try {
        const response = await fetch(URL_GOOGLE_SHEETS + '?t=' + new Date().getTime());
        const data = await response.json();
        if (data) {
            db.stockFuel.diesel = parseFloat(data.ultimoDiesel);
            db.stockFuel.gasohol = parseFloat(data.ultimoGasohol);
            db.historial = data.historialNube || [];
            actualizarUI();
            actualizarGrafico();
        }
    } catch (e) { document.getElementById('statusCloud').innerText = "‚ö†Ô∏è Modo Local"; }
}

function actualizarUI() {
    document.getElementById('sDiesel').innerText = db.stockFuel.diesel.toFixed(2);
    document.getElementById('sGasohol').innerText = db.stockFuel.gasohol.toFixed(2);

    // Alertas visuales
    const boxD = document.getElementById('boxD');
    const boxG = document.getElementById('boxG');
    const alertD = document.getElementById('alertD');
    const alertG = document.getElementById('alertG');

    if(db.stockFuel.diesel <= STOCK_CRITICO.diesel) { boxD.classList.add('alerta-roja'); alertD.style.display = 'block'; }
    else { boxD.classList.remove('alerta-roja'); alertD.style.display = 'none'; }

    if(db.stockFuel.gasohol <= STOCK_CRITICO.gasohol) { boxG.classList.add('alerta-roja'); alertG.style.display = 'block'; }
    else { boxG.classList.remove('alerta-roja'); alertG.style.display = 'none'; }

    document.getElementById('historialBody').innerHTML = db.historial.slice(0, 10).map(h => `
        <tr><td>${h.fecha}</td><td style="color:${h.mov==='INGRESO'?'green':'red'}"><b>${h.mov}</b></td>
        <td style="color:${h.prod==='GASOHOL'?'var(--gasohol)':'var(--diesel)'}">${h.prod}</td>
        <td>${h.cant}</td><td>${h.ref}</td><td><b>${h.saldo}</b></td></tr>`).join('');
}

function actualizarGrafico() {
    const dias = {};
    const hoy = new Date();
    
    // Inicializar √∫ltimos 7 d√≠as
    for(let i=6; i>=0; i--) {
        let d = new Date();
        d.setDate(hoy.getDate() - i);
        dias[d.toLocaleDateString()] = { DIESEL: 0, GASOHOL: 0 };
    }

    db.historial.forEach(h => {
        let f = new Date(h.fecha).toLocaleDateString();
        if(dias[f] && h.mov === 'SALIDA') {
            dias[f][h.prod] += parseFloat(h.cant);
        }
    });

    const labels = Object.keys(dias);
    const dataDiesel = labels.map(l => dias[l].DIESEL);
    const dataGasohol = labels.map(l => dias[l].GASOHOL);

    if (consumoChart) consumoChart.destroy();

    const ctx = document.getElementById('chartConsumo').getContext('2d');
    consumoChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.map(l => l.split('/')[0] + '/' + l.split('/')[1]),
            datasets: [
                { label: 'Diesel', data: dataDiesel, backgroundColor: '#2563eb' },
                { label: 'Gasohol', data: dataGasohol, backgroundColor: '#10b981' }
            ]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
}

function procesarMovimiento() {
    const mov = document.getElementById('tipoMov').value;
    const prod = document.getElementById('prod').value;
    const cant = parseFloat(document.getElementById('cant').value);
    const ref = document.getElementById('referencia').value || (mov === 'salida' ? 'DESPACHO' : 'INGRESO');

    if (isNaN(cant) || cant <= 0) return alert("Cantidad inv√°lida");

    let nD = db.stockFuel.diesel;
    let nG = db.stockFuel.gasohol;

    if(prod === 'DIESEL') nD = (mov === 'salida') ? nD - cant : nD + cant;
    else nG = (mov === 'salida') ? nG - cant : nG + cant;

    fetch(URL_GOOGLE_SHEETS, {
        method: 'POST',
        mode: 'no-cors',
        body: JSON.stringify({
            tipo: mov.toUpperCase(), producto: prod, cantidad: cant, responsable: ref.toUpperCase(),
            stockDiesel: nD, stockGasohol: nG
        })
    }).then(() => {
        setTimeout(cargarDatosDesdeNube, 2000);
    });
    
    document.getElementById('cant').value = "";
}

cargarDatosDesdeNube();
setInterval(cargarDatosDesdeNube, 60000);
</script>
</body>
</html>
