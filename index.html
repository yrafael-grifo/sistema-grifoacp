<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="UTF-8">
<title>SISTEMA ACP V15 - CONTROL TOTAL</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root { --p:#1e293b; --a:#3b82f6; --d:#2563eb; --g:#10b981; --err:#ef4444; --warn:#f59e0b; --ok:#059669; }
body { font-family: sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
.dash { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1350px; margin: auto; }
.card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-top: 5px solid var(--a); }
.full { grid-column: span 2; }
.btn { cursor: pointer; padding: 12px; border: none; border-radius: 6px; font-weight: bold; color: white; width: 100%; text-align: center; display: block; text-decoration: none; }
.btn-b { background: var(--a); margin-top: 10px; }
.btn-s { background: #6366f1; width: auto; padding: 8px 15px; display: inline-block; }
.stock-box { padding: 15px; border-radius: 10px; text-align: center; background: #f8fafc; border: 3px solid #e2e8f0; transition: 0.5s; }
.val { font-size: 2.2rem; font-weight: 800; display: block; }
.sem-ok { border-color: var(--ok) !important; background: #f0fdf4 !important; }
.sem-alert { border-color: var(--warn) !important; background: #fffbeb !important; }
.sem-crit { border-color: var(--err) !important; background: #fee2e2 !important; animation: blink 1.5s infinite; }
@keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e2e8f0; }
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
.modal-c { background: white; margin: 2% auto; padding: 25px; width: 90%; max-width: 700px; border-radius: 15px; }
.sim-card { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; margin-bottom: 10px; box-sizing: border-box; }
</style>
</head>
<body>
<div class="dash">
<div class="card full" style="background: var(--p); color: white; display:flex; justify-content:space-between; align-items:center;">
<div><h2 style="margin:0">‚õΩ Control ACP - Gesti√≥n Operativa</h2><small id="cloudStatus">Conectando...</small></div>
<div style="display:flex; gap:10px;">
<button onclick="openSim()" class="btn btn-s">üìä Simulador</button>
<button onclick="exportXLS()" class="btn btn-s" style="background:#107c41">üì• Excel</button>
</div>
</div>
<div class="card">
<h3>üìù Registro de Operaci√≥n</h3>
<select id="tMov" onchange="checkIng()"><option value="salida">Salida (Despacho)</option><option value="ingreso">Ingreso (Cisterna)</option></select>
<select id="tProd"><option value="DIESEL">Diesel</option><option value="GASOHOL">Gasohol</option></select>
<input type="number" id="tCant" placeholder="Cantidad gl">
<div id="extra" style="display:none;"><input type="text" id="tRef" placeholder="Referencia / Placa"></div>
<button id="btnSave" class="btn btn-b" onclick="saveData()">Guardar Operaci√≥n</button>
</div>
<div class="card">
<h3>üöö Monitor de Stock (Ciclos 24h)</h3>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
<div id="bD" class="stock-box"><b>Diesel</b><span id="vD" class="val" style="color:var(--d)">0.00</span><span id="aD" style="background:var(--p); color:white; padding:2px 6px; border-radius:4px; font-size:0.8em">---</span></div>
<div id="bG" class="stock-box"><b>Gasohol</b><span id="vG" class="val" style="color:var(--g)">0.00</span><span id="aG" style="background:var(--p); color:white; padding:2px 6px; border-radius:4px; font-size:0.8em">---</span></div>
</div>
</div>
<div class="card full">
<h3>üõ† Mantenimiento de Equipos</h3>
<table><thead><tr><th>Equipo</th><th>Filtro</th><th>√öltima Fecha</th><th>D√≠as</th><th>Estado</th><th>Acci√≥n</th></tr></thead><tbody id="mantoBody"></tbody></table>
</div>
<div class="card full">
<h3>üìù Historial Reciente</h3>
<table><thead><tr><th>Fecha</th><th>Mov</th><th>Prod</th><th>Cant</th><th>Saldo</th></tr></thead><tbody id="histBody"></tbody></table>
</div>
</div>
<div id="mSim" class="modal">
<div class="modal-c">
<h2>üìä Planificaci√≥n de Pedido</h2>
<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
<div class="sim-card"><b>Consumo Diario (24h)</b>


Diesel: 1,700 gl


Gasohol: 165 gl</div>
<div class="sim-card" style="background:#e0f2fe;"><b>Autonom√≠a Real</b>


Diesel: <span id="sD">0</span> d


Gasohol: <span id="sG">0</span> d</div>
</div>
<div style="background:#f8fafc; padding:15px; border:2px solid var(--a); border-radius:8px">
<h3>üõí An√°lisis Operativo</h3>
<p id="txtSug" style="font-size:0.95em; line-height:1.4;"></p>
<label>Diesel a pedir:</label><input type="number" id="pD">
<label>Gasohol a pedir:</label><input type="number" id="pG">
<button onclick="sendMail()" class="btn" style="background:var(--ok)">üìß Enviar Pedido a Compras</button>
<p id="mailStatus" style="text-align:center; margin-top:10px; font-weight:bold;"></p>
</div>
<button onclick="closeSim()" class="btn" style="background:#94a3b8; margin-top:10px;">Cerrar</button>
</div>
</div>
<script>
const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbzQEQvDebG9gprHH4XNGNbiM7EW5CWRy5rjJHhKw3MUJJ5_P4YV7muU_TupuCwCau-z/exec';
let core = { stock: { d: 0, g: 0 }, hist: [], units: [{id:'Surtidor 1', f:'CF60', u:'2026-01-15'},{id:'Surtidor 2', f:'CF60', u:'2026-01-23'},{id:'Hipotanque', f:'CF100', u:'2025-12-10'},{id:'Gasohol', f:'MALLA', u:'2026-01-15'}] };

async function loadData() {
try {
const r = await fetch(URL_SCRIPT + '?t=' + new Date().getTime());
const d = await r.json();
core.stock.d = parseFloat(d.ultimoDiesel);
core.stock.g = parseFloat(d.ultimoGasohol);
core.hist = d.historialNube || [];
render();
document.getElementById('cloudStatus').innerText = "‚úÖ Sincronizado";
} catch (e) { document.getElementById('cloudStatus').innerText = "‚ö†Ô∏è Error de Red"; }
}

function render() {
const aD = (core.stock.d / 1700).toFixed(1);
const aG = (core.stock.g / 165).toFixed(1);
document.getElementById('vD').innerText = core.stock.d.toFixed(2);
document.getElementById('vG').innerText = core.stock.g.toFixed(2);
document.getElementById('aD').innerText = aD + " d";
document.getElementById('aG').innerText = aG + " d";

const bD = document.getElementById('bD'); bD.className = 'stock-box';
if(aD < 1.0) bD.classList.add('sem-crit'); else if(aD < 2.0) bD.classList.add('sem-alert'); else bD.classList.add('sem-ok');

const bG = document.getElementById('bG'); bG.className = 'stock-box';
if(aG < 1.5) bG.classList.add('sem-crit'); else if(aG < 3.0) bG.classList.add('sem-alert'); else bG.classList.add('sem-ok');

const hoy = new Date();
document.getElementById('mantoBody').innerHTML = core.units.map((u, i) => {
    const diff = Math.floor((hoy - new Date(u.u)) / 86400000);
    return '<tr><td>'+u.id+'</td><td>'+u.f+'</td><td>'+u.u+'</td><td>'+diff+' d</td><td>OK</td><td><button onclick="resetManto('+i+')">Reset</button></td></tr>';
}).join('');
document.getElementById('histBody').innerHTML = core.hist.slice(0,12).map(h => '<tr><td>'+h.fecha+'</td><td>'+h.mov+'</td><td>'+h.prod+'</td><td>'+h.cant+'</td><td>'+h.saldo+'</td></tr>').join('');
}

function saveData() {
const m = document.getElementById('tMov').value.toUpperCase();
const p = document.getElementById('tProd').value;
const c = parseFloat(document.getElementById('tCant').value);
const r = document.getElementById('tRef').value || "DESPACHO";
if(!c) return alert("Cantidad inv√°lida");
let nD = core.stock.d; let nG = core.stock.g;
if(p === 'DIESEL') nD = m === 'SALIDA' ? nD - c : nD + c; else nG = m === 'SALIDA' ? nG - c : nG + c;
fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tipo: m, producto: p, cantidad: c, responsable: r, stockDiesel: nD.toFixed(2), stockGasohol: nG.toFixed(2) }) }).then(() => { core.stock.d = nD; core.stock.g = nG; render(); setTimeout(loadData, 1500); });
}

function openSim() {
document.getElementById('mSim').style.display = 'block';
const sD = core.stock.d; const sG = core.stock.g;
const autoD = (sD / 1700).toFixed(1);
const autoG = (sG / 165).toFixed(1);
document.getElementById('sD').innerText = autoD;
document.getElementById('sG').innerText = autoG;

let sugD = sD < 3400 ? 3000 : 0;
let sugG = sG < 400 ? 500 : 0;

let txt = "";
if(sugD > 0) txt += "‚ö†Ô∏è DIESEL: Stock bajo. Pedir 3,000 gl hoy.<br>";
if(sugG > 0) txt += "‚ö†Ô∏è GASOHOL: Autonom√≠a cr√≠tica. Pedir 500 gl.<br>";
if(sugD == 0 && sugG == 0) txt = "‚úÖ Todo en orden para las pr√≥ximas 24h.";

document.getElementById('txtSug').innerHTML = txt;
document.getElementById('pD').value = sugD;
document.getElementById('pG').value = sugG;
}

function sendMail() {
const d = document.getElementById('pD').value;
const g = document.getElementById('pG').value;
const s = document.getElementById('mailStatus');
s.innerText = "‚è≥ Enviando orden..."; s.style.color = "blue";
fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ tipo: "PEDIDO_SIMULADO", cantidadDiesel: d, cantidadGasohol: g, actualD: core.stock.d, actualG: core.stock.g }) }).then(() => { s.innerText = "‚úÖ Orden enviada a Compras"; setTimeout(closeSim, 2500); });
}

function exportXLS() {
const ws = XLSX.utils.json_to_sheet(core.hist.map(h => ({ FECHA: h.fecha, MOV: h.mov, PROD: h.prod, CANT: h.cant, REF: h.ref, SALDO: h.saldo })));
const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Historial");
XLSX.writeFile(wb, "Reporte_ACP_V15.xlsx");
}

function closeSim() { document.getElementById('mSim').style.display = 'none'; }
function checkIng() { document.getElementById('extra').style.display = document.getElementById('tMov').value === 'ingreso' ? 'block' : 'none'; }
function resetManto(i) { core.units[i].u = new Date().toISOString().split('T')[0]; render(); }
loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
